<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES Advanced Remover (Machines & Defects)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Cloudflare Turnstile Script -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        /* === CORE STYLES === */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #e2e8f0; min-height: 100vh; padding: 20px; padding-bottom: 80px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* HEADER */
        .header { text-align: center; margin-bottom: 20px; padding: 20px; background: rgba(30, 41, 59, 0.8); border-radius: 15px; border: 1px solid #3b82f6; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .header h1 { font-size: 26px; margin-bottom: 5px; color: #60a5fa; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .header p { color: #94a3b8; font-size: 14px; }

        /* TAB NAVIGATION */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: rgba(15, 23, 42, 0.6); color: #94a3b8; font-weight: 600; cursor: pointer; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab-btn:hover { background: rgba(59, 130, 246, 0.1); color: #fff; }
        .tab-btn.active { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.1); }
        .tab-btn.active-danger { background: rgba(220, 38, 38, 0.2); color: #f87171; border-color: #ef4444; }

        /* MAIN PANEL */
        .main-panel { background: rgba(30, 41, 59, 0.6); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(59, 130, 246, 0.2); position: relative; }
        
        /* CONFIG AREA */
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .config-card { background: rgba(15, 23, 42, 0.8); padding: 15px; border-radius: 10px; border-left: 4px solid #3b82f6; }
        .config-card h3 { color: #60a5fa; margin-bottom: 10px; font-size: 15px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #cbd5e1; font-size: 12px; }
        .form-control { width: 100%; padding: 10px 12px; background: rgba(255, 255, 255, 0.08); border: 1px solid #475569; border-radius: 6px; color: #fff; font-size: 13px; transition: 0.2s; }
        .form-control:focus { border-color: #60a5fa; outline: none; background: rgba(255, 255, 255, 0.12); }
        
        /* PACKAGE INFO */
        .package-details-box { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 10px; margin-top: 10px; display: none; }
        .package-id-display { font-size: 13px; color: #10b981; font-weight: bold; word-break: break-all; margin-bottom: 5px; }
        .package-meta-display { display: flex; flex-wrap: wrap; gap: 5px; font-size: 11px; }
        .meta-tag { background: rgba(15, 23, 42, 0.6); padding: 3px 6px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }

        /* ACTION BUTTONS */
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 20px 0; }
        .btn { padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(110%); }
        .btn-primary { background: #2563eb; } /* Blue */
        .btn-danger { background: #dc2626; } /* Red */
        .btn-warning { background: #d97706; } /* Orange */
        .btn-secondary { background: #475569; } /* Slate */
        .btn-stop { background: #7c3aed; } /* Purple */
        
        /* LIST CONTAINERS */
        .list-container { max-height: 500px; overflow-y: auto; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; background: rgba(15, 23, 42, 0.8); margin-top: 15px; }
        .empty-state { padding: 40px; text-align: center; color: #64748b; }
        
        /* ITEMS: MACHINE */
        .machine-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 12px; align-items: flex-start; }
        .machine-item.selected { background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; }
        .machine-info { flex: 1; font-size: 13px; }
        .machine-title { color: #e2e8f0; font-weight: 700; }
        .iot-row { background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px; margin-top: 4px; font-size: 11px; color: #94a3b8; display: flex; justify-content: space-between; }
        
        /* ITEMS: DEFECT */
        .defect-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 15px; align-items: center; border-left: 3px solid transparent; }
        .defect-item:hover { background: rgba(255,255,255,0.02); }
        .defect-icon { width: 40px; height: 40px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .defect-info { flex: 1; }
        .defect-name { color: #f87171; font-weight: 700; font-size: 14px; margin-bottom: 3px; }
        .defect-meta { font-size: 12px; color: #94a3b8; display: flex; gap: 10px; }
        .defect-id { background: rgba(255,255,255,0.1); padding: 1px 6px; border-radius: 4px; font-family: monospace; }
        
        /* PROGRESS BAR */
        .progress-container { margin: 15px 0; display: none; }
        .progress-bar { height: 18px; background: rgba(255, 255, 255, 0.1); border-radius: 9px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); width: 0%; transition: width 0.3s; }
        .progress-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        
        /* LOG CONSOLE */
        .log-console { background: #0f172a; border-radius: 8px; padding: 10px; margin-top: 15px; max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 11px; border: 1px solid #334155; }
        .log-entry { margin-bottom: 3px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; display: flex; }
        .log-time { color: #64748b; min-width: 65px; margin-right: 8px; }
        .log-success { color: #10b981; } .log-error { color: #ef4444; } .log-info { color: #60a5fa; } .log-warn { color: #f59e0b; }

        /* FLOATING WIDGET (Secured) */
        .turnstile-floating { position: fixed; bottom: 20px; right: 20px; z-index: 999; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #3b82f6; width: 300px; transition: 0.3s; overflow: hidden; }
        .turnstile-header { padding: 8px 12px; background: #eff6ff; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #bfdbfe; }
        .turnstile-title { font-size: 12px; font-weight: bold; color: #1e40af; }
        .turnstile-body { padding: 12px; display: flex; justify-content: center; }
        .turnstile-floating.minimized { width: 48px; height: 48px; border-radius: 50%; bottom: 30px; right: 30px; cursor: pointer; }
        .turnstile-floating.minimized .turnstile-content { display: none; }
        .turnstile-icon { display: none; font-size: 20px; color: #2563eb; width: 100%; height: 100%; align-items: center; justify-content: center; }
        .turnstile-floating.minimized .turnstile-icon { display: flex; }

        /* UTILS */
        .d-none { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1><i class="fas fa-tools"></i> MES Advanced Remover</h1>
            <p>C√¥ng c·ª• x·ª≠ l√Ω d·ªØ li·ªáu S·∫£n xu·∫•t (Machines & Defects)</p>
        </div>
        
        <!-- MAIN PANEL -->
        <div class="main-panel">
            <!-- TABS -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('machine')">
                    <i class="fas fa-satellite-dish"></i> Qu·∫£n L√Ω M√°y (IoT)
                </button>
                <button class="tab-btn" id="btn-tab-defect" onclick="switchTab('defect')">
                    <i class="fas fa-bug"></i> Qu·∫£n L√Ω L·ªói (Defects)
                </button>
            </div>

            <!-- SHARED CONFIG -->
            <div class="config-grid">
                <div class="config-card">
                    <h3><i class="fas fa-key"></i> X√°c Th·ª±c & C·∫•u H√¨nh</h3>
                    <div class="form-group">
                        <label>API Key (Required):</label>
                        <input type="password" id="apiKey" class="form-control" placeholder="Nh·∫≠p API Key qu·∫£n tr·ªã...">
                    </div>
                    <div class="form-group">
                        <label>Nh√† m√°y:</label>
                        <select id="factory" class="form-control">
                            <option value="P2C1">P2C1</option>
                            <option value="P2A1">P2A1</option>
                            <option value="P2B1">P2B1</option>
                        </select>
                    </div>
                </div>
                
                <div class="config-card">
                    <h3><i class="fas fa-box"></i> Ch·ªçn Package</h3>
                    <div class="form-group">
                        <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                            <input type="date" id="searchDate" class="form-control">
                            <button class="btn btn-secondary" onclick="loadTodayPackages()" title="T·∫£i danh s√°ch"><i class="fas fa-sync"></i></button>
                        </div>
                        <select id="packageSelect" class="form-control">
                            <option value="">-- Ch·ªçn Package --</option>
                        </select>
                        <input type="text" id="mxpackage" class="form-control" placeholder="Ho·∫∑c nh·∫≠p Package ID th·ªß c√¥ng..." style="margin-top: 8px;">
                    </div>
                    
                    <div id="packageInfoBox" class="package-details-box">
                        <div class="package-id-display" id="pkgIdDisplay"></div>
                        <div class="package-meta-display" id="pkgMetaDisplay"></div>
                    </div>
                </div>
            </div>
            
            <!-- PROGRESS BAR (Shared) -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>

            <!-- TAB CONTENT: MACHINE -->
            <div id="tab-content-machine">
                <div class="action-grid">
                    <button class="btn btn-primary" onclick="startFullScanProcess()" id="scanBtn" disabled>üîí Ch·ªù x√°c th·ª±c</button>
                    <button class="btn btn-stop" onclick="stopProcess()" id="stopBtn" style="display: none;"><i class="fas fa-stop"></i> D·ª´ng</button>
                    <button class="btn btn-warning" onclick="handleSelection(true)" id="selectAllBtn" disabled><i class="fas fa-check-double"></i> Ch·ªçn H·∫øt</button>
                    <button class="btn btn-warning" onclick="handleSelection(false)" id="deselectAllBtn" disabled><i class="fas fa-times"></i> B·ªè Ch·ªçn</button>
                    <button class="btn btn-danger" onclick="confirmRemoveMachines()" id="removeBtn" disabled><i class="fas fa-trash"></i> X√≥a M√°y</button>
                </div>
                
                <div style="text-align: right; font-size: 12px; color: #94a3b8; margin-bottom: 5px;">
                    M√°y t√¨m th·∫•y: <strong style="color:#10b981" id="statFound">0</strong> | ƒê√£ ch·ªçn: <strong style="color:#facc15" id="statSelected">0</strong>
                </div>

                <div class="list-container" id="machineListContainer">
                    <div class="empty-state">
                        <i class="fas fa-search-location" style="font-size: 30px; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Nh·∫≠p Package ID v√† nh·∫•n "Qu√©t Chi Ti·∫øt" ƒë·ªÉ xem danh s√°ch m√°y.</p>
                    </div>
                </div>
            </div>

            <!-- TAB CONTENT: DEFECT -->
            <div id="tab-content-defect" class="d-none">
                <div class="action-grid">
                    <button class="btn btn-primary" onclick="scanDefects()" id="scanDefectBtn" disabled>
                        <i class="fas fa-search-plus"></i> Qu√©t L·ªói (Scan Defects)
                    </button>
                    <div style="flex-grow: 1;"></div> <!-- Spacer -->
                    <button class="btn btn-danger" onclick="confirmRemoveDefects()" id="removeDefectBtn" disabled>
                        <i class="fas fa-dumpster-fire"></i> X√≥a T·∫•t C·∫£ L·ªói (Delete All)
                    </button>
                </div>

                <div style="text-align: right; font-size: 12px; color: #94a3b8; margin-bottom: 5px;">
                    T·ªïng s·ªë l·ªói t√¨m th·∫•y: <strong style="color:#f87171; font-size: 14px;" id="statDefectFound">0</strong>
                </div>

                <div class="list-container" id="defectListContainer" style="border-color: rgba(239, 68, 68, 0.3);">
                    <div class="empty-state">
                        <i class="fas fa-bug" style="font-size: 30px; margin-bottom: 10px; opacity: 0.5; color: #f87171;"></i>
                        <p>Nh·∫≠p Package ID v√† nh·∫•n "Qu√©t L·ªói" ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu l·ªói.</p>
                    </div>
                </div>
            </div>
            
            <!-- LOGS -->
            <div class="log-console" id="logConsole">
                <div class="log-entry"><span class="log-time">[SYSTEM]</span><span class="log-info">Ready. Please verify security widget.</span></div>
            </div>
        </div>
    </div>

    <!-- FLOATING TURNSTILE WIDGET -->
    <div id="turnstileWidget" class="turnstile-floating">
        <div class="turnstile-content">
            <div class="turnstile-header">
                <div class="turnstile-title"><i class="fas fa-shield-alt"></i> B·∫£o M·∫≠t Cloudflare</div>
                <button onclick="toggleWidget(true)" style="background:none;border:none;cursor:pointer;">‚ûñ</button>
            </div>
            <div class="turnstile-body">
                <div id="cf-turnstile-widget" class="cf-turnstile" 
                     data-sitekey="0x4AAAAAACKJOBIKvTV3je0V" 
                     data-callback="onTurnstileSuccess"
                     data-error-callback="onTurnstileError"
                     data-expired-callback="onTurnstileExpired">
                </div>
            </div>
        </div>
        <div class="turnstile-icon" onclick="toggleWidget(false)">üîê</div>
    </div>

    <script>
        // === CONFIGURATION ===
        // URL Worker ch√≠nh ƒë√£ t√≠ch h·ª£p (Endpoints: /remove-machine, /scan-defects, /remove-defects)
        const WORKER_BASE_URL = "https://remove-machine.chiscoong-cloudflare-com.workers.dev";
        const PACKAGE_API = "https://today-package.chiscoong-cloudflare-com.workers.dev/api/packages";
        const MODULE_OPS_API = "https://module-requests.chiscoong-cloudflare-com.workers.dev/opdetails";
        const MODULE_DETAIL_API = "https://module-requests.chiscoong-cloudflare-com.workers.dev/detail";

        // === STATE VARIABLES ===
        let turnstileToken = null;
        let isLocalhost = window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1');
        let currentTab = 'machine';
        let isProcessing = false;
        let abortController = null;
        
        // Data Stores
        let discoveredMachines = [];
        let discoveredDefects = [];

        // === TAB LOGIC ===
        function switchTab(tabName) {
            currentTab = tabName;
            
            // UI Toggle
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'active-danger'));
            document.getElementById('tab-content-machine').classList.add('d-none');
            document.getElementById('tab-content-defect').classList.add('d-none');

            if(tabName === 'machine') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('tab-content-machine').classList.remove('d-none');
            } else {
                document.getElementById('btn-tab-defect').classList.add('active', 'active-danger');
                document.getElementById('tab-content-defect').classList.remove('d-none');
            }
        }

        // === TURNSTILE HANDLERS ===
        function toggleWidget(minimize) {
            const el = document.getElementById('turnstileWidget');
            minimize ? el.classList.add('minimized') : el.classList.remove('minimized');
        }

        window.onTurnstileSuccess = function(token) {
            turnstileToken = token;
            log("‚úÖ X√°c th·ª±c b·∫£o m·∫≠t th√†nh c√¥ng.", "success");
            toggleWidget(true);
            enableMainButtons(true);
        };

        window.onTurnstileError = () => { enableMainButtons(false, "‚ùå L·ªói x√°c th·ª±c"); };
        window.onTurnstileExpired = () => { enableMainButtons(false, "üîí H·∫øt h·∫°n - Reset"); toggleWidget(false); };

        function enableMainButtons(enable, msg) {
            const btnScan = document.getElementById('scanBtn');
            const btnScanDefect = document.getElementById('scanDefectBtn');
            
            if(enable) {
                btnScan.disabled = false; btnScan.innerHTML = '<i class="fas fa-search"></i> Qu√©t M√°y Chi Ti·∫øt';
                btnScanDefect.disabled = false; btnScanDefect.innerHTML = '<i class="fas fa-search-plus"></i> Qu√©t L·ªói (Scan Defects)';
            } else {
                btnScan.disabled = true; btnScan.innerHTML = msg || 'üîí Ch·ªù x√°c th·ª±c';
                btnScanDefect.disabled = true; btnScanDefect.innerHTML = msg || 'üîí Ch·ªù x√°c th·ª±c';
            }
        }

        // === CORE: PACKAGE PARSING & UTILS ===
        function log(msg, type = 'info') {
            const el = document.getElementById('logConsole');
            const time = new Date().toLocaleTimeString('vi-VN', {hour12: false});
            el.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span><span class="log-${type}">${msg}</span></div>`;
            el.scrollTop = el.scrollHeight;
        }

        function getCommonParams() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const pkgId = document.getElementById('mxpackage').value.trim();
            if(!apiKey || !pkgId) { alert("Vui l√≤ng nh·∫≠p API Key v√† Package ID!"); return null; }
            return { apiKey, pkgId };
        }

        function parseMxPackage(mxpackage) {
            try {
                const match = mxpackage.match(/([A-Z0-9]+)(\d{6})(?=_|$)/);
                if (!match) return { success: false };
                const fullStr = match[0];
                const len = fullStr.length;
                return {
                    stylecode: fullStr.substring(0, len - 6).slice(0, -3), // Simplified
                    stylesize: fullStr.substring(0, len - 6).slice(-3),
                    stylecolorserial: fullStr.substring(len - 6, len - 3),
                    revno: fullStr.substring(len - 3),
                    success: true
                };
            } catch (e) { return { success: false }; }
        }

        // === FEATURE 1: MACHINE SCANNER (Existing Logic) ===
        async function startFullScanProcess() {
            const params = getCommonParams();
            if(!params) return;
            
            isProcessing = true;
            abortController = new AbortController();
            discoveredMachines = [];
            
            toggleUIState(true);
            document.getElementById('machineListContainer').innerHTML = '';
            document.getElementById('statFound').innerText = '0';
            
            log(`üöÄ B·∫Øt ƒë·∫ßu qu√©t M√ÅY cho package: ${params.pkgId}`, 'info');

            try {
                // 1. Get Operations (Old Logic)
                const styleInfo = parseMxPackage(params.pkgId);
                const opsUrl = `${MODULE_OPS_API}?mxpackage=${encodeURIComponent(params.pkgId)}&mode=operations&apikey=${params.apiKey}`;
                const opsRes = await fetch(opsUrl, { signal: abortController.signal });
                const opsData = await opsRes.json();
                
                if(!opsData.success || !opsData.data?.operations) throw new Error("Kh√¥ng th·ªÉ l·∫•y danh s√°ch OP.");
                
                const operations = opsData.data.operations;
                
                // 2. Loop & Scan Details
                for(let i=0; i<operations.length; i++) {
                    const op = operations[i];
                    updateProgress((i/operations.length)*100, `Scanning OP: ${op.opserial}`);
                    
                    try {
                        let detailUrl = `${MODULE_DETAIL_API}?stylecode=${styleInfo.stylecode || ''}&stylesize=${styleInfo.stylesize || ''}&stylecolorserial=${styleInfo.stylecolorserial || ''}&revno=${styleInfo.revno || ''}&oprevno=${op.oprevno}&opserial=${op.opserial}&apikey=${params.apiKey}`;
                        const detailRes = await fetch(detailUrl, { signal: abortController.signal });
                        const detailJson = await detailRes.json();
                        
                        if(detailJson.success && detailJson.data?.Result?.MachineList) {
                            detailJson.data.Result.MachineList.forEach(m => {
                                if(m.MCID && m.MCID !== 'N/A') {
                                    discoveredMachines.push({
                                        pkg: params.pkgId,
                                        mcid: m.MCID,
                                        opserial: op.opserial,
                                        opname: op.opname,
                                        module: op.modulename,
                                        iotType: (op.iottype || 'NONE').toUpperCase(),
                                        lastIotData: m.LAST_IOT_DATA,
                                        selected: false
                                    });
                                }
                            });
                        }
                    } catch (e) {}
                }
                
                renderMachines();
                log(`‚úÖ Qu√©t xong. T√¨m th·∫•y ${discoveredMachines.length} m√°y.`, 'success');

            } catch (e) {
                log(`‚ùå L·ªói qu√©t m√°y: ${e.message}`, 'error');
            } finally {
                isProcessing = false;
                toggleUIState(false);
                updateProgress(100, "S·∫µn s√†ng");
            }
        }

        function renderMachines() {
            const container = document.getElementById('machineListContainer');
            document.getElementById('statFound').innerText = discoveredMachines.length;
            
            if(discoveredMachines.length === 0) {
                container.innerHTML = `<div class="empty-state">Kh√¥ng t√¨m th·∫•y m√°y n√†o.</div>`;
                return;
            }
            
            let html = '';
            discoveredMachines.forEach((m, idx) => {
                html += `
                    <div class="machine-item" id="machine-${idx}">
                        <input type="checkbox" style="width:18px;height:18px;accent-color:#f59e0b;" onchange="toggleMachine(${idx})">
                        <div class="machine-info">
                            <div class="machine-title"><span style="color:#60a5fa">${m.mcid}</span> - ${m.opname}</div>
                            <div style="color:#94a3b8;margin-top:2px;">OP: ${m.opserial} | Module: ${m.module}</div>
                            <div class="iot-row">
                                <span>IoT Type: <strong>${m.iotType}</strong></span>
                                <span>Last Data: <strong style="color:#2dd4bf">${m.lastIotData || 'N/A'}</strong></span>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Handle Machine Actions
        async function confirmRemoveMachines() {
            const selected = discoveredMachines.filter(m => m.selected);
            if(selected.length === 0) return;
            if(!confirm(`X√≥a ${selected.length} m√°y ƒë√£ ch·ªçn?`)) return;
            
            const params = getCommonParams();
            isProcessing = true; toggleUIState(true);
            
            let success = 0;
            for(let i=0; i<selected.length; i++) {
                const item = selected[i];
                updateProgress((i/selected.length)*100, `Removing: ${item.mcid}`);
                
                // NEW ENDPOINT: /remove-machine
                let url = `${WORKER_BASE_URL}/remove-machine?apikey=${params.apiKey}&mxpackage=${encodeURIComponent(item.pkg)}&mcid=${encodeURIComponent(item.mcid)}&opserial=${item.opserial}`;
                if (turnstileToken && !isLocalhost) url += `&cf-turnstile-response=${encodeURIComponent(turnstileToken)}`;

                try {
                    const res = await fetch(url);
                    const json = await res.json();
                    if(json.IsSuccess) {
                        success++;
                        log(`üóëÔ∏è ƒê√£ x√≥a m√°y: ${item.mcid}`, 'success');
                        const row = document.getElementById(`machine-${discoveredMachines.indexOf(item)}`);
                        row.style.opacity = '0.4'; row.style.textDecoration = 'line-through';
                    } else throw new Error(json.Log);
                } catch(e) { log(`‚ö†Ô∏è L·ªói ${item.mcid}: ${e.message}`, 'error'); }
            }
            
            isProcessing = false; toggleUIState(false);
            log(`üèÅ Ho√†n t·∫•t x√≥a m√°y. Th√†nh c√¥ng: ${success}/${selected.length}`, 'info');
        }

        // === FEATURE 2: DEFECT SCANNER (New Logic) ===
        async function scanDefects() {
            const params = getCommonParams();
            if(!params) return;

            isProcessing = true;
            toggleUIState(true);
            document.getElementById('defectListContainer').innerHTML = '<div class="empty-state">ƒêang qu√©t d·ªØ li·ªáu...</div>';
            log(`üîé B·∫Øt ƒë·∫ßu qu√©t DEFECTS cho package: ${params.pkgId}`, 'info');

            try {
                // NEW ENDPOINT: /scan-defects
                let url = `${WORKER_BASE_URL}/scan-defects?apikey=${params.apiKey}&mxpackage=${encodeURIComponent(params.pkgId)}&opserial=0`;
                if (turnstileToken && !isLocalhost) url += `&cf-turnstile-response=${encodeURIComponent(turnstileToken)}`;

                const res = await fetch(url);
                const json = await res.json();

                if(json.IsSuccess) {
                    discoveredDefects = json.FoundDefects || [];
                    renderDefects();
                    log(`‚úÖ T√¨m th·∫•y ${discoveredDefects.length} defect items.`, 'success');
                } else {
                    throw new Error(json.Log || "L·ªói kh√¥ng x√°c ƒë·ªãnh");
                }
            } catch (e) {
                log(`‚ùå L·ªói qu√©t defect: ${e.message}`, 'error');
                document.getElementById('defectListContainer').innerHTML = `<div class="empty-state" style="color:#ef4444">${e.message}</div>`;
            } finally {
                isProcessing = false;
                toggleUIState(false);
            }
        }

        function renderDefects() {
            const container = document.getElementById('defectListContainer');
            document.getElementById('statDefectFound').innerText = discoveredDefects.length;
            document.getElementById('removeDefectBtn').disabled = discoveredDefects.length === 0;

            if(discoveredDefects.length === 0) {
                container.innerHTML = `<div class="empty-state">Kh√¥ng t√¨m th·∫•y l·ªói n√†o trong package n√†y.</div>`;
                return;
            }

            let html = '';
            discoveredDefects.forEach(d => {
                html += `
                    <div class="defect-item">
                        <div class="defect-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="defect-info">
                            <div class="defect-name">${d.defectNameVi || d.defectName}</div>
                            <div class="defect-meta">
                                <span class="defect-id">ID: ${d.id}</span>
                                <span><i class="fas fa-user"></i> ${d.createdUser}</span>
                                <span><i class="far fa-clock"></i> ${new Date(d.createdDate).toLocaleDateString()}</span>
                                <span style="color:#cbd5e1">| Cat: ${d.categoryNameVi || d.categoryName}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function confirmRemoveDefects() {
            const count = discoveredDefects.length;
            if(count === 0) return;
            
            const confirmMsg = `C·∫¢NH B√ÅO NGUY HI·ªÇM!\n\nB·∫°n s·∫Øp X√ìA TO√ÄN B·ªò ${count} l·ªói c·ªßa Package n√†y.\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.\n\nNh·∫•n OK ƒë·ªÉ x√°c nh·∫≠n x√≥a.`;
            if(!confirm(confirmMsg)) return;

            const params = getCommonParams();
            isProcessing = true; toggleUIState(true);
            log(`üî• B·∫Øt ƒë·∫ßu x√≥a ${count} defects...`, 'warn');

            // NEW ENDPOINT: /remove-defects (POST)
            const url = `${WORKER_BASE_URL}/remove-defects`;
            const payload = {
                mxpackage: params.pkgId,
                opserial: 0,
                confirmDelete: true,
                apikey: params.apiKey // Helper sends in body or url
            };
            
            // Add params to URL for auth check in middleware if needed, or rely on body
            // Worker code reads headers/url for apikey mostly. Let's put apikey in URL too just in case.
            const postUrl = `${url}?apikey=${params.apiKey}`;

            try {
                const res = await fetch(postUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(turnstileToken && !isLocalhost ? {'cf-turnstile-response': turnstileToken} : {})
                    },
                    body: JSON.stringify(payload)
                });
                
                const json = await res.json();
                
                if(json.IsSuccess) {
                    log(`‚úÖ ${json.Log}`, 'success');
                    // Refresh List
                    discoveredDefects = [];
                    renderDefects();
                } else {
                    log(`‚ö†Ô∏è X√≥a th·∫•t b·∫°i: ${json.Log}`, 'error');
                }
            } catch (e) {
                log(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'error');
            } finally {
                isProcessing = false;
                toggleUIState(false);
            }
        }

        // === UTILS: UI HELPERS ===
        function toggleUIState(processing) {
            document.getElementById('progressContainer').style.display = processing ? 'block' : 'none';
            document.getElementById('stopBtn').style.display = processing ? 'inline-flex' : 'none';
            
            const btns = ['scanBtn', 'selectAllBtn', 'deselectAllBtn', 'removeBtn', 'scanDefectBtn', 'removeDefectBtn'];
            btns.forEach(id => {
                const b = document.getElementById(id);
                if(b) b.disabled = processing;
            });
            
            // Re-enable removal buttons if data exists and not processing
            if(!processing) {
                if(currentTab === 'machine') updateStats();
                if(currentTab === 'defect' && discoveredDefects.length > 0) document.getElementById('removeDefectBtn').disabled = false;
            }
        }
        
        function updateStats() {
            const count = discoveredMachines.filter(m => m.selected).length;
            document.getElementById('statSelected').innerText = count;
            document.getElementById('removeBtn').disabled = count === 0;
        }
        
        function updateProgress(pct, text) {
            document.getElementById('progressFill').style.width = `${pct}%`;
            document.getElementById('progressText').innerText = `${Math.round(pct)}% - ${text}`;
        }
        
        function handleSelection(isSelect) {
            discoveredMachines.forEach(m => m.selected = isSelect);
            renderMachines(); // Simple re-render to update checkboxes
            updateStats();
        }
        
        function toggleMachine(idx) {
            discoveredMachines[idx].selected = !discoveredMachines[idx].selected;
            updateStats();
        }
        
        function stopProcess() {
            if(abortController) abortController.abort();
            isProcessing = false;
            log('‚õî ƒê√£ d·ª´ng ti·∫øn tr√¨nh.', 'warn');
        }

        // === INIT & PACKAGE LOADING ===
        document.getElementById('factory').value = 'P2C1';
        document.getElementById('searchDate').valueAsDate = new Date();

        async function loadTodayPackages() {
            const params = { apiKey: document.getElementById('apiKey').value.trim() };
            const factory = document.getElementById('factory').value;
            const dateInput = document.getElementById('searchDate').value.replace(/-/g, '');
            const select = document.getElementById('packageSelect');
            
            if(!params.apiKey) { alert("Nh·∫≠p API Key!"); return; }
            select.innerHTML = '<option>Loading...</option>';

            try {
                const url = `${PACKAGE_API}?factory=${factory}&fromDate=${dateInput}&withDetails=true&apikey=${encodeURIComponent(params.apiKey)}`;
                const res = await fetch(url);
                const data = await res.json();
                
                select.innerHTML = '<option value="">-- Ch·ªçn Package --</option>';
                const pkgs = (data.data?.packages || data.data || []).sort((a,b) => (a.LINENAME||"").localeCompare(b.LINENAME||""));
                
                let currentLine = null;
                pkgs.forEach(p => {
                    const line = p.lineName || p.LINENAME || "Unknown";
                    if(line !== currentLine) {
                        currentLine = line;
                        const sep = document.createElement('option');
                        sep.text = `‚îÄ‚îÄ‚îÄ LINE ${line} ‚îÄ‚îÄ‚îÄ`; sep.disabled = true;
                        select.add(sep);
                    }
                    const opt = document.createElement('option');
                    opt.value = p.packageId || p.MXPACKAGE;
                    opt.text = `${line} | ${p.styleText || p.STYLETEXT} | Target: ${p.target || p.TARGET}`;
                    opt.dataset.meta = JSON.stringify({ line, style: p.styleText || p.STYLETEXT, target: p.target || p.TARGET });
                    select.add(opt);
                });
            } catch(e) { select.innerHTML = '<option>L·ªói t·∫£i data</option>'; }
        }

        document.getElementById('packageSelect').addEventListener('change', function() {
            if(this.value) {
                document.getElementById('mxpackage').value = this.value;
                const meta = JSON.parse(this.options[this.selectedIndex].dataset.meta || '{}');
                document.getElementById('packageInfoBox').style.display = 'block';
                document.getElementById('pkgIdDisplay').innerText = this.value;
                document.getElementById('pkgMetaDisplay').innerHTML = `
                    <span class="meta-tag">${document.getElementById('factory').value}</span>
                    <span class="meta-tag">${meta.line}</span>
                    <span class="meta-tag" style="color:#facc15">${meta.style}</span>
                `;
            }
        });

        // Localhost bypass
        if (isLocalhost) {
            document.getElementById('turnstileWidget').style.display = 'none';
            enableMainButtons(true);
        }
    </script>
</body>
</html>
