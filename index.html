<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove machine IoT Scanner (Secured)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Cloudflare Turnstile Script -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        /* === GI·ªÆ NGUY√äN STYLE C≈® === */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #e2e8f0; min-height: 100vh; padding: 20px; padding-bottom: 80px; /* Th√™m padding ƒë√°y ƒë·ªÉ widget kh√¥ng che n·ªôi dung */ }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; padding: 25px; background: rgba(30, 41, 59, 0.8); border-radius: 15px; border: 1px solid #3b82f6; }
        .header h1 { font-size: 28px; margin-bottom: 10px; color: #60a5fa; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .main-panel { background: rgba(30, 41, 59, 0.6); border-radius: 15px; padding: 25px; margin-bottom: 25px; border: 1px solid rgba(59, 130, 246, 0.3); }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .config-card { background: rgba(15, 23, 42, 0.8); padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6; }
        .config-card h3 { color: #60a5fa; margin-bottom: 15px; font-size: 16px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e1; font-size: 13px; }
        .form-control { width: 100%; padding: 12px 15px; background: rgba(255, 255, 255, 0.1); border: 1px solid #475569; border-radius: 6px; color: #fff; font-size: 13px; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        .package-details-box { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 15px; margin-top: 15px; display: none; }
        .package-id-display { font-size: 13px; color: #10b981; font-weight: bold; margin-bottom: 8px; border-bottom: 1px dashed rgba(16, 185, 129, 0.3); padding-bottom: 8px; word-break: break-all; }
        .package-meta-display { font-size: 13px; color: #e2e8f0; display: flex; flex-wrap: wrap; gap: 8px; }
        .meta-tag { background: rgba(15, 23, 42, 0.6); padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }
        .meta-highlight { color: #facc15; font-weight: bold; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-primary { background: #2563eb; }
        .btn-danger { background: #dc2626; }
        .btn-warning { background: #d97706; }
        .btn-secondary { background: #475569; }
        .btn-stop { background: #7c3aed; }
        .btn-fa { background: #db2777; }
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin: 25px 0; }
        .machine-list-container { max-height: 550px; overflow-y: auto; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; background: rgba(15, 23, 42, 0.8); margin-top: 20px; }
        .machine-item { padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: flex-start; gap: 15px; }
        .machine-item:last-child { border-bottom: none; }
        .machine-item.selected { background: rgba(245, 158, 11, 0.15); border-left: 3px solid #f59e0b; }
        .machine-checkbox { width: 18px; height: 18px; margin-top: 4px; cursor: pointer; accent-color: #f59e0b; }
        .machine-info { flex: 1; }
        .machine-row-1 { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; flex-wrap: wrap; }
        .machine-title { color: #e2e8f0; font-weight: 700; font-size: 14px; }
        .machine-module { color: #94a3b8; font-size: 13px; }
        .machine-remarks { color: #facc15; font-size: 13px; font-style: italic; }
        .machine-row-2 { margin-bottom: 6px; font-size: 13px; color: #cbd5e1; }
        .mcid-tag { color: #60a5fa; font-weight: bold; background: rgba(59, 130, 246, 0.1); padding: 2px 6px; border-radius: 4px; }
        .machine-iot-row { background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(45, 212, 191, 0.2); border-radius: 6px; padding: 8px; margin-top: 5px; font-size: 12px; display: flex; flex-direction: column; gap: 3px; }
        .iot-value { color: #2dd4bf; font-weight: bold; }
        .iot-time-label { color: #94a3b8; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .iot-time-value { color: #e2e8f0; font-family: 'Consolas', monospace; }
        .progress-container { margin: 20px 0; display: none; }
        .progress-bar { width: 100%; height: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); width: 0%; transition: width 0.3s; }
        .progress-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 11px; }
        .log-console { background: #0f172a; border-radius: 8px; padding: 15px; margin-top: 20px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 11px; border: 1px solid #334155; }
        .log-entry { margin-bottom: 4px; display: flex; gap: 10px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }
        .log-time { color: #64748b; min-width: 60px; }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-info { color: #60a5fa; }
        .iot-badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; background: #64748b; color: white; }
        .iot-fa { background: #10b981; }
        .iot-qa { background: #3b82f6; }

        /* === NEW: FLOATING TURNSTILE WIDGET CSS === */
        .turnstile-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255,255,255,0.1);
            border: 1px solid rgba(59, 130, 246, 0.4);
            width: 320px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .turnstile-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 16px;
            background: linear-gradient(to right, #eff6ff, #fff);
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }
        .turnstile-title { font-size: 0.85rem; font-weight: 700; color: #2563eb; display: flex; gap: 8px; align-items: center; }
        .turnstile-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 6px; font-weight: 600; }
        .status-pending { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .status-success { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #64748b; padding: 0 4px; }
        .turnstile-body { padding: 16px; display: flex; flex-direction: column; align-items: center; }
        .turnstile-note { font-size: 0.7rem; color: #64748b; margin-top: 10px; text-align: center; }
        
        /* Logic ·∫©n/hi·ªán widget */
        .turnstile-content { opacity: 1; visibility: visible; transition: opacity 0.3s; width: 100%; }
        .turnstile-minimized-icon {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer;
            opacity: 0; visibility: hidden; transition: opacity 0.3s;
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
        }
        .turnstile-floating.minimized {
            width: 56px; height: 56px; border-radius: 50%;
            cursor: pointer; border-color: transparent;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.5);
            bottom: 30px; right: 30px;
        }
        .turnstile-floating.minimized .turnstile-content { opacity: 0; visibility: hidden; position: absolute; }
        .turnstile-floating.minimized .turnstile-minimized-icon { opacity: 1; visibility: visible; }
        .turnstile-floating.minimized:hover { transform: scale(1.1); }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1><i class="fas fa-satellite-dish"></i> Remove machine IoT Scanner</h1>
            <p>Qu√©t chi ti·∫øt m√°y, d·ªØ li·ªáu IoT v√† x√≥a h√†ng lo·∫°t m√°y (Secured)</p>
        </div>
        
        <!-- MAIN -->
        <div class="main-panel">
            <div class="config-grid">
                <!-- API CONFIG -->
                <div class="config-card">
                    <h3><i class="fas fa-key"></i> C·∫•u H√¨nh</h3>
                    <div class="form-group">
                        <label>API Key:</label>
                        <input type="password" id="apiKey" class="form-control" placeholder="Nh·∫≠p API Key qu·∫£n tr·ªã...">
                    </div>
                    <div class="form-group">
                        <label>Nh√† m√°y:</label>
                        <select id="factory" class="form-control">
                            <option value="P2C1">P2C1</option>
                            <option value="P2A1">P2A1</option>
                            <option value="P2B1">P2B1</option>
                        </select>
                    </div>
                </div>
                
                <!-- PACKAGE SELECT -->
                <div class="config-card">
                    <h3><i class="fas fa-box"></i> Ch·ªçn Package</h3>
                    <div class="form-group">
                        <label>Ng√†y s·∫£n xu·∫•t (M·∫∑c ƒë·ªãnh: H√¥m nay):</label>
                        <input type="date" id="searchDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label>Danh s√°ch Package:</label>
                        <div style="display: flex; gap: 8px;">
                            <select id="packageSelect" class="form-control">
                                <option value="">-- Ch·ªçn Package --</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadTodayPackages()" id="loadPackagesBtn" title="T·∫£i danh s√°ch"><i class="fas fa-sync"></i></button>
                        </div>
                        <input type="text" id="mxpackage" class="form-control" placeholder="Ho·∫∑c nh·∫≠p Package ID..." style="margin-top: 10px;">
                    </div>
                    
                    <div id="packageInfoBox" class="package-details-box">
                        <div class="package-id-display" id="pkgIdDisplay"></div>
                        <div class="package-meta-display" id="pkgMetaDisplay"></div>
                    </div>
                </div>
            </div>
            
            <!-- ACTIONS -->
            <div class="action-grid">
                <!-- N√∫t n√†y m·∫∑c ƒë·ªãnh disabled cho ƒë·∫øn khi captcha ƒë∆∞·ª£c x√°c th·ª±c -->
                <button class="btn btn-primary" onclick="startFullScanProcess()" id="scanBtn" disabled style="opacity:0.6; cursor:not-allowed;">üîí Ch·ªù x√°c th·ª±c</button>
                <button class="btn btn-stop" onclick="stopScanProcess()" id="stopBtn" style="display: none;"><i class="fas fa-stop"></i> D·ª´ng</button>
                <button class="btn btn-warning" onclick="handleSelection(true)" id="selectAllBtn" disabled><i class="fas fa-check-double"></i> Ch·ªçn H·∫øt</button>
                <button class="btn btn-warning" onclick="handleSelection(false)" id="deselectAllBtn" disabled><i class="fas fa-times"></i> B·ªè Ch·ªçn</button>
                <button class="btn btn-fa" onclick="confirmSendFa()" id="sendFaBtn" disabled><i class="fas fa-paper-plane"></i> G·ª≠i FA</button>
                <button class="btn btn-danger" onclick="confirmRemoveMachines()" id="removeBtn" disabled><i class="fas fa-trash"></i> X√≥a M√°y</button>
            </div>
            
            <!-- PROGRESS -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>
            
            <!-- STATS -->
            <div style="text-align: right; margin-bottom: 10px; font-size: 12px; color: #94a3b8;">
                M√°y t√¨m th·∫•y: <strong style="color:#10b981" id="statFound">0</strong> | 
                ƒê√£ ch·ªçn: <strong style="color:#facc15" id="statSelected">0</strong>
            </div>
            
            <!-- LIST -->
            <div class="machine-list-container" id="machineListContainer">
                <div style="padding: 40px; text-align: center; color: #64748b;">
                    <i class="fas fa-search-location" style="font-size: 40px; margin-bottom: 10px; opacity: 0.3;"></i>
                    <p>Nh·∫•n "Qu√©t Chi Ti·∫øt" ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu IoT</p>
                </div>
            </div>
            
            <!-- LOGS -->
            <div class="log-console" id="logConsole">
                <div class="log-entry"><span class="log-time">[SYSTEM]</span><span class="log-info">Ready to scan. Please verify security widget.</span></div>
            </div>
        </div>
    </div>

    <!-- FLOATING TURNSTILE WIDGET -->
    <div id="turnstileWidget" class="turnstile-floating">
        <div class="turnstile-content">
            <div class="turnstile-header">
                <div class="turnstile-title"><i class="fas fa-shield-alt"></i> B·∫£o M·∫≠t H·ªá Th·ªëng</div>
                <div style="display:flex; align-items:center; gap:8px;">
                   <span id="turnstileStatus" class="turnstile-badge status-pending">ƒêang ch·ªù</span>
                   <button id="btnMinimize" class="btn-icon" title="Thu nh·ªè">‚îÄ</button>
                </div>
            </div>
            <div class="turnstile-body">
                <div id="cf-turnstile-widget" class="cf-turnstile" 
                     data-sitekey="0x4AAAAAACKJOBIKvTV3je0V" 
                     data-callback="onTurnstileSuccess"
                     data-error-callback="onTurnstileError"
                     data-expired-callback="onTurnstileExpired"
                     data-theme="light">
                </div>
                <div class="turnstile-note">T·ª± ƒë·ªông ·∫©n sau khi x√°c th·ª±c th√†nh c√¥ng.</div>
            </div>
        </div>
        <div class="turnstile-minimized-icon" title="Nh·∫•n ƒë·ªÉ m·ªü x√°c th·ª±c">
            <span id="minimizedIconChar">üîê</span>
        </div>
    </div>

    <script>
        const PACKAGE_API = "https://today-package.chiscoong-cloudflare-com.workers.dev/api/packages";
        const MODULE_OPS_API = "https://module-requests.chiscoong-cloudflare-com.workers.dev/opdetails";
        const MODULE_DETAIL_API = "https://module-requests.chiscoong-cloudflare-com.workers.dev/detail";
        const REMOVE_API = "https://remove-machine.chiscoong-cloudflare-com.workers.dev/";
        const SCANNER_API = "https://mes-qr-scanner.chiscoong-cloudflare-com.workers.dev/";
        
        // --- TURNSTILE CONFIG & VARIABLES ---
        const TOKEN_MAX_AGE = 270 * 1000; // 4.5 Ph√∫t
        let turnstileToken = null;
        let tokenTimestamp = 0;
        let tokenRefreshResolver = null;
        let isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        let discoveredMachines = [];
        let isProcessing = false;
        let abortController = null;
        
        // --- TURNSTILE WIDGET LOGIC ---
        const widgetEl = document.getElementById('turnstileWidget');
        const btnMinimize = document.getElementById('btnMinimize');

        function toggleWidgetState(forceMinimize = false) {
            if (forceMinimize) widgetEl.classList.add('minimized');
            else widgetEl.classList.toggle('minimized');
        }

        btnMinimize.addEventListener('click', (e) => { e.stopPropagation(); toggleWidgetState(true); });
        widgetEl.addEventListener('click', () => { if (widgetEl.classList.contains('minimized')) toggleWidgetState(false); });

        // Callback x√°c th·ª±c th√†nh c√¥ng
        window.onTurnstileSuccess = function(token) {
            turnstileToken = token;
            tokenTimestamp = Date.now();
            
            // Update UI
            document.getElementById('turnstileStatus').textContent = "ƒê√£ x√°c th·ª±c";
            document.getElementById('turnstileStatus').className = "turnstile-badge status-success";
            document.getElementById('minimizedIconChar').textContent = "‚úÖ";
            
            // Enable Scan button if it was disabled
            const scanBtn = document.getElementById('scanBtn');
            if(scanBtn.disabled && !isProcessing) {
                scanBtn.disabled = false;
                scanBtn.innerHTML = '<i class="fas fa-search"></i> Qu√©t Chi Ti·∫øt';
                scanBtn.style.opacity = "1";
                scanBtn.style.cursor = "pointer";
            }

            // Logic Auto-Resume
            if (tokenRefreshResolver) {
                log("‚ôªÔ∏è Token ƒë√£ ƒë∆∞·ª£c gia h·∫°n! Ti·∫øp t·ª•c x·ª≠ l√Ω...", "success");
                tokenRefreshResolver(true);
                tokenRefreshResolver = null;
                setTimeout(() => toggleWidgetState(true), 1000);
            } else {
                log("‚úÖ ƒê√£ x√°c th·ª±c b·∫£o m·∫≠t.", "success");
                setTimeout(() => toggleWidgetState(true), 1500);
            }
        };

        window.onTurnstileError = function() {
            turnstileToken = null;
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('scanBtn').textContent = "‚ùå L·ªói x√°c th·ª±c";
            document.getElementById('minimizedIconChar').textContent = "‚ö†Ô∏è";
        };

        window.onTurnstileExpired = function() {
            turnstileToken = null;
            if (!tokenRefreshResolver && !isProcessing) {
                document.getElementById('scanBtn').disabled = true;
                document.getElementById('scanBtn').textContent = "üîí H·∫øt h·∫°n - X√°c th·ª±c l·∫°i";
                document.getElementById('minimizedIconChar').textContent = "üîê";
                toggleWidgetState(false);
                log("‚ö†Ô∏è Phi√™n x√°c th·ª±c h·∫øt h·∫°n.", "warning");
            }
        };

        // H√†m ƒë·ª£i ng∆∞·ªùi d√πng gia h·∫°n token
        async function refreshTurnstileToken() {
            log("‚è≥ Token s·∫Øp h·∫øt h·∫°n. T·∫°m d·ª´ng ƒë·ªÉ x√°c th·ª±c l·∫°i...", "warning");
            
            toggleWidgetState(false);
            document.getElementById('turnstileStatus').textContent = "C·∫ßn gia h·∫°n";
            document.getElementById('turnstileStatus').className = "turnstile-badge status-pending";
            
            if(window.turnstile) window.turnstile.reset('#cf-turnstile-widget');
            
            await new Promise(resolve => { tokenRefreshResolver = resolve; });
        }

        // --- HELPER FUNCTIONS ---

        function log(msg, type = 'info') {
            const el = document.getElementById('logConsole');
            const time = new Date().toLocaleTimeString('vi-VN', {hour12: false});
            el.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span><span class="log-${type}">${msg}</span></div>`;
            el.scrollTop = el.scrollHeight;
        }

        function formatDateTime(isoString) {
            if (!isoString) return "N/A";
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return isoString;
                const d = String(date.getDate()).padStart(2, '0');
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const y = date.getFullYear();
                const hh = String(date.getHours()).padStart(2, '0');
                const mm = String(date.getMinutes()).padStart(2, '0');
                const ss = String(date.getSeconds()).padStart(2, '0');
                return `${d}/${m}/${y} - ${hh}:${mm}:${ss}`;
            } catch (e) { return "Invalid Date"; }
        }

        function parseMxPackage(mxpackage) {
            try {
                const match = mxpackage.match(/([A-Z0-9]+)(\d{6})(?=_|$)/);
                if (!match) return { success: false };
                
                const fullStr = match[0];
                const len = fullStr.length;
                const revno = fullStr.substring(len - 3);
                const color = fullStr.substring(len - 6, len - 3);
                const leftPart = fullStr.substring(0, len - 6);
                const last3 = leftPart.slice(-3);
                const last2 = leftPart.slice(-2);
                
                let stylecode = "", stylesize = "";
                
                if (/^[A-Z]+$/.test(last3)) {
                    stylesize = last3;
                    stylecode = leftPart.slice(0, -3);
                } else {
                    stylesize = last2;
                    stylecode = leftPart.slice(0, -2);
                }

                return {
                    stylecode: stylecode,
                    stylesize: stylesize,
                    stylecolorserial: color,
                    revno: revno,
                    success: true
                };
            } catch (e) {
                console.error(e);
                return { success: false };
            }
        }

        // --- H√ÄM S·∫ÆP X·∫æP LINE (T·ª™ MES-BATCH-UPLOADER) ---
        function compareLines(a, b) {
            const lineA = (a.lineName || a.LINENAME || "").toUpperCase();
            const lineB = (b.lineName || b.LINENAME || "").toUpperCase();
            const matchA = lineA.match(/(\d+)/);
            const matchB = lineB.match(/(\d+)/);
            if (matchA && matchB) {
                const numA = parseInt(matchA[0]);
                const numB = parseInt(matchB[0]);
                if (numA !== numB) return numA - numB;
            } else if (matchA && !matchB) return -1;
            else if (!matchA && matchB) return 1;
            return lineA.localeCompare(lineB);
        }

        // --- CORE LOGIC ---

        async function startFullScanProcess() {
            // Ki·ªÉm tra token tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu
            if (!turnstileToken && !isLocalhost) {
                alert("Vui l√≤ng ho√†n th√†nh x√°c th·ª±c b·∫£o m·∫≠t tr∆∞·ªõc!");
                toggleWidgetState(false);
                return;
            }

            const apiKey = document.getElementById('apiKey').value.trim();
            const pkgId = document.getElementById('mxpackage').value.trim();
            
            if(!apiKey || !pkgId) { alert("Thi·∫øu API Key ho·∫∑c Package ID!"); return; }
            
            isProcessing = true;
            abortController = new AbortController();
            discoveredMachines = [];
            toggleButtons(true);
            document.getElementById('machineListContainer').innerHTML = '';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('statFound').innerText = '0';
            
            log(`B·∫Øt ƒë·∫ßu qu√©t g√≥i: ${pkgId}`, 'info');
            
            try {
                const styleInfo = parseMxPackage(pkgId);
                if(!styleInfo.success) throw new Error("Kh√¥ng th·ªÉ ph√¢n t√≠ch Package ID. ƒê·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£.");
                
                log(`Parsed: Style ${styleInfo.stylecode} | Size ${styleInfo.stylesize} | Color ${styleInfo.stylecolorserial} | Rev ${styleInfo.revno}`, 'success');

                const opsUrl = `${MODULE_OPS_API}?mxpackage=${encodeURIComponent(pkgId)}&mode=operations&apikey=${apiKey}`;
                const opsRes = await fetch(opsUrl, { signal: abortController.signal });
                const opsData = await opsRes.json();
                
                if(!opsData.success || !opsData.data?.operations) throw new Error("L·ªói l·∫•y danh s√°ch c√¥ng ƒëo·∫°n.");
                
                const operations = opsData.data.operations;
                log(`T√¨m th·∫•y ${operations.length} c√¥ng ƒëo·∫°n.`, 'info');
                
                for(let i=0; i<operations.length; i++) {
                    // Check Token Age b√™n trong v√≤ng l·∫∑p qu√©t d√†i
                    if (!isLocalhost && (Date.now() - tokenTimestamp > TOKEN_MAX_AGE)) {
                        await refreshTurnstileToken();
                    }

                    const op = operations[i];
                    updateProgress((i/operations.length)*100, `Qu√©t OP: ${op.opserial}`);
                    
                    try {
                        let detailUrl = `${MODULE_DETAIL_API}?stylecode=${styleInfo.stylecode}&stylesize=${styleInfo.stylesize}&stylecolorserial=${styleInfo.stylecolorserial}&revno=${styleInfo.revno}&oprevno=${op.oprevno}&opserial=${op.opserial}&apikey=${apiKey}`;
                        // Th√™m token v√†o request n·∫øu c·∫ßn (m·ªôt s·ªë API read c≈©ng check)
                        if (turnstileToken && !isLocalhost) detailUrl += `&cf-turnstile-response=${encodeURIComponent(turnstileToken)}`;

                        const detailRes = await fetch(detailUrl, { signal: abortController.signal });
                        const detailJson = await detailRes.json();
                        
                        if(detailJson.success && detailJson.data?.Result?.MachineList) {
                            detailJson.data.Result.MachineList.forEach(m => {
                                if(m.MCID && m.MCID !== 'N/A') {
                                    discoveredMachines.push({
                                        pkg: pkgId,
                                        mcid: m.MCID,
                                        opserial: op.opserial,
                                        opname: op.opname || 'Unknown',
                                        module: op.modulename || op.MODULENAME || 'N/A',
                                        remarks: op.remarks || op.REMARKS || '', 
                                        iotType: (op.iottype || 'NONE').toUpperCase(),
                                        lastIotData: m.LAST_IOT_DATA,
                                        lastIotTime: m.LAST_IOT_DATA_RECEIVE_TIME,
                                        selected: false
                                    });
                                }
                            });
                        }
                    } catch (err) {}
                    await new Promise(r => setTimeout(r, 100));
                }
                
                renderMachines();
                log(`Ho√†n t·∫•t. T√¨m th·∫•y ${discoveredMachines.length} m√°y.`, 'success');
                
            } catch (e) {
                if(e.name === 'AbortError') log("ƒê√£ d·ª´ng qu√©t.", 'warning');
                else log(`L·ªói: ${e.message}`, 'error');
            } finally {
                isProcessing = false;
                toggleButtons(false);
                updateProgress(100, "Ho√†n t·∫•t");
            }
        }

        function renderMachines() {
            const container = document.getElementById('machineListContainer');
            document.getElementById('statFound').innerText = discoveredMachines.length;
            
            if(discoveredMachines.length === 0) {
                container.innerHTML = `<div style="padding:30px;text-align:center;color:#ef4444">Kh√¥ng t√¨m th·∫•y m√°y n√†o. Vui l√≤ng ki·ªÉm tra l·∫°i Package ID.</div>`;
                return;
            }
            
            let html = '';
            discoveredMachines.forEach((m, idx) => {
                const badgeClass = m.iotType === 'FA' ? 'iot-fa' : (m.iotType === 'QA' ? 'iot-qa' : 'iot-none');
                const iotDataDisplay = (m.lastIotData !== null && m.lastIotData !== undefined) ? m.lastIotData : 'N/A';
                const iotTimeDisplay = formatDateTime(m.lastIotTime);
                const remarksPart = m.remarks ? ` | <span class="machine-remarks">${m.remarks}</span>` : '';
                
                html += `
                    <div class="machine-item" id="machine-${idx}">
                        <input type="checkbox" class="machine-checkbox" onchange="toggleMachine(${idx})">
                        <div class="machine-info">
                            <div class="machine-row-1">
                                <span class="machine-title">${m.opname}</span>
                                <span style="color:#64748b">|</span>
                                <span class="machine-module">${m.module}</span>
                                ${remarksPart}
                            </div>
                            <div class="machine-row-2">
                                <span class="mcid-tag">${m.mcid}</span>
                                <span style="margin: 0 5px;">‚Ä¢</span>
                                <span>OP: <strong>${m.opserial}</strong></span>
                                <span style="margin-left: 10px;" class="iot-badge ${badgeClass}">${m.iotType}</span>
                            </div>
                            <div class="machine-iot-row">
                                <div><span class="iot-time-label">IoT Data:</span> <span class="iot-value">${iotDataDisplay}</span></div>
                                <div><span class="iot-time-label">TH·ªúI GIAN NH·∫¨N D·ªÆ LI·ªÜU IoT CU·ªêI C√ôNG:</span> <span class="iot-time-value">${iotTimeDisplay}</span></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function handleSelection(isSelect) {
            discoveredMachines.forEach(m => m.selected = isSelect);
            document.querySelectorAll('.machine-checkbox').forEach(cb => cb.checked = isSelect);
            document.querySelectorAll('.machine-item').forEach(el => isSelect ? el.classList.add('selected') : el.classList.remove('selected'));
            updateStats();
        }
        
        function toggleMachine(idx) {
            discoveredMachines[idx].selected = !discoveredMachines[idx].selected;
            const el = document.getElementById(`machine-${idx}`);
            discoveredMachines[idx].selected ? el.classList.add('selected') : el.classList.remove('selected');
            updateStats();
        }
        
        function updateStats() {
            const count = discoveredMachines.filter(m => m.selected).length;
            document.getElementById('statSelected').innerText = count;
            document.getElementById('removeBtn').disabled = count === 0;
            document.getElementById('sendFaBtn').disabled = count === 0;
        }

        function updateProgress(pct, text) {
            document.getElementById('progressFill').style.width = `${pct}%`;
            document.getElementById('progressText').innerText = `${Math.round(pct)}% - ${text}`;
        }
        
        function stopScanProcess() { if(abortController) abortController.abort(); isProcessing = false; }

        function toggleButtons(disabled) {
            document.getElementById('scanBtn').style.display = disabled ? 'none' : 'inline-flex';
            document.getElementById('stopBtn').style.display = disabled ? 'inline-flex' : 'none';
            ['selectAllBtn', 'deselectAllBtn', 'removeBtn', 'sendFaBtn', 'loadPackagesBtn'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.disabled = disabled;
            });
        }

        async function confirmSendFa() {
            const selected = discoveredMachines.filter(m => m.selected);
            if(confirm(`G·ª≠i l·ªánh FA ƒë·∫øn ${selected.length} m√°y ƒë√£ ch·ªçn?`)) processBatch(selected, 'FA');
        }

        async function confirmRemoveMachines() {
            const selected = discoveredMachines.filter(m => m.selected);
            if(confirm(`C·∫¢NH B√ÅO: X√≥a ${selected.length} m√°y kh·ªèi Package?`)) processBatch(selected, 'REMOVE');
        }

        async function processBatch(items, action) {
            const apiKey = document.getElementById('apiKey').value.trim();
            isProcessing = true;
            toggleButtons(true);
            document.getElementById('progressContainer').style.display = 'block';
            let success = 0, fail = 0;
            
            for(let i=0; i<items.length; i++) {
                // --- AUTO REFRESH TOKEN LOGIC ---
                if (!isLocalhost && (Date.now() - tokenTimestamp > TOKEN_MAX_AGE)) {
                    await refreshTurnstileToken(); // T·∫°m d·ª´ng v√≤ng l·∫∑p, ch·ªù user x√°c th·ª±c
                }

                const item = items[i];
                updateProgress((i/items.length)*100, `${action}: ${item.mcid}`);
                
                try {
                    let url = action === 'FA' 
                        ? `${SCANNER_API}?apikey=${apiKey}&mxpackage=${encodeURIComponent(item.pkg)}&mcid=${encodeURIComponent(item.mcid)}&opserial=${item.opserial}&processtype=FA`
                        : `${REMOVE_API}?apikey=${apiKey}&mxpackage=${encodeURIComponent(item.pkg)}&mcid=${encodeURIComponent(item.mcid)}&opserial=${item.opserial}`;
                    
                    // Th√™m Token v√†o request
                    if (turnstileToken && !isLocalhost) url += `&cf-turnstile-response=${encodeURIComponent(turnstileToken)}`;

                    const res = await fetch(url);
                    const json = await res.json();
                    
                    if(json.IsSuccess) {
                        success++;
                        log(`‚úÖ ${action} OK: ${item.mcid}`, 'success');
                        const row = document.getElementById(`machine-${discoveredMachines.indexOf(item)}`);
                        if(action === 'REMOVE') {
                            row.style.opacity = '0.4'; row.style.textDecoration = 'line-through';
                            row.querySelector('input').disabled = true; item.selected = false;
                        } else {
                            row.style.background = 'rgba(16, 185, 129, 0.1)';
                        }
                    } else throw new Error(json.Log || 'Fail');
                } catch(e) {
                    fail++;
                    log(`‚ùå L·ªói ${item.mcid}: ${e.message}`, 'error');
                }
                await new Promise(r => setTimeout(r, 1000));
            }
            isProcessing = false;
            toggleButtons(false);
            updateProgress(100, `Ho√†n t·∫•t: ${success} OK, ${fail} L·ªói`);
            updateStats();
        }

        // --- H√ÄM LOAD PACKAGES V·ªöI S·∫ÆP X·∫æP LINE ---
        async function loadTodayPackages() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const factory = document.getElementById('factory').value;
            const select = document.getElementById('packageSelect');
            const dateInput = document.getElementById('searchDate').value;
            
            let dateStr;
            if (dateInput) {
                dateStr = dateInput.replace(/-/g, '');
                log(`ƒêang t√¨m Package cho ng√†y: ${dateInput}`, 'info');
            } else {
                dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                log(`Kh√¥ng ch·ªçn ng√†y, m·∫∑c ƒë·ªãnh t√¨m h√¥m nay: ${new Date().toLocaleDateString()}`, 'info');
            }

            if(!apiKey) { alert("Nh·∫≠p API Key tr∆∞·ªõc!"); return; }
            select.innerHTML = '<option>Loading...</option>';
            
            try {
                // Th√™m withDetails=true ƒë·ªÉ l·∫•y ƒë·∫ßy ƒë·ªß th√¥ng tin line
                let url = `${PACKAGE_API}?factory=${factory}&fromDate=${dateStr}&withDetails=true&apikey=${encodeURIComponent(apiKey)}`;
                
                const res = await fetch(url);
                const data = await res.json();
                select.innerHTML = '<option value="">-- Ch·ªçn Package --</option>';
                
                let pkgs = [];
                if (data.success) {
                    pkgs = data.data?.packages || data.data || [];
                } else if (Array.isArray(data)) {
                    pkgs = data;
                } else if (data.data && Array.isArray(data.data)) {
                    pkgs = data.data;
                }
                
                if (pkgs.length === 0) {
                     select.innerHTML = '<option value="">-- Kh√¥ng c√≥ d·ªØ li·ªáu --</option>';
                     log('Kh√¥ng t√¨m th·∫•y package n√†o.', 'warning');
                     return;
                }

                // S·∫Øp x·∫øp danh s√°ch package theo line
                pkgs.sort(compareLines);
                
                // Hi·ªÉn th·ªã v·ªõi separator ph√¢n nh√≥m line (gi·ªëng mes-batch-uploader)
                let currentLine = null;
                pkgs.forEach(p => {
                    const lineName = p.lineName || p.LINENAME || "Unknown";
                    
                    // Th√™m separator khi line thay ƒë·ªïi
                    if (lineName !== currentLine) {
                        currentLine = lineName;
                        const separator = document.createElement('option');
                        separator.value = `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ LINE ${currentLine} ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`;
                        separator.disabled = true;
                        separator.style.color = '#64748b';
                        separator.style.fontStyle = 'italic';
                        separator.style.backgroundColor = '#f1f5f9';
                        select.add(separator);
                    }
                    
                    const id = p.packageId || p.MXPACKAGE;
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.text = `${p.lineName || p.LINENAME} | ${p.styleText || p.STYLETEXT} | ${p.target || p.TARGET || 0}`;
                    opt.dataset.details = JSON.stringify({
                        line: p.lineName || p.LINENAME,
                        style: p.styleText || p.STYLETEXT,
                        target: p.target || p.TARGET,
                        factory: factory
                    });
                    select.add(opt);
                });
                log(`ƒê√£ t·∫£i ${pkgs.length} package (ƒë√£ s·∫Øp x·∫øp theo line).`, 'success');
            } catch(e) {
                select.innerHTML = '<option>L·ªói t·∫£i data</option>';
                log(`L·ªói t·∫£i package: ${e.message}`, 'error');
            }
        }
        
        // X·ª≠ l√Ω khi ch·ªçn package t·ª´ dropdown
        document.getElementById('packageSelect').addEventListener('change', function() {
            const selectedValue = this.value;
            
            // N·∫øu ch·ªçn nh·∫ßm separator (d√≤ng ph√¢n c√°ch) th√¨ b·ªè qua
            if(selectedValue && selectedValue.startsWith('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ')) {
                this.value = ''; // Reset selection
                return;
            }
            
            if(selectedValue) {
                document.getElementById('mxpackage').value = selectedValue;
                const selectedOption = this.options[this.selectedIndex];
                
                // Ki·ªÉm tra xem option c√≥ dataset.details kh√¥ng
                if(selectedOption.dataset.details) {
                    const data = JSON.parse(selectedOption.dataset.details);
                    document.getElementById('packageInfoBox').style.display = 'block';
                    document.getElementById('pkgIdDisplay').innerText = selectedValue;
                    document.getElementById('pkgMetaDisplay').innerHTML = `
                        <span class="meta-tag">${data.factory}</span>
                        <span class="meta-tag">${data.line}</span>
                        <span class="meta-tag meta-highlight">${data.style}</span>
                        <span class="meta-tag">Target: ${data.target}</span>
                    `;
                }
            }
        });

        // INIT
        document.getElementById('factory').value = 'P2C1';
        document.getElementById('searchDate').valueAsDate = new Date();

        // Localhost bypass check
        if (isLocalhost) {
            log("Running in Localhost mode - Turnstile bypassed.", "warning");
            document.getElementById('turnstileWidget').style.display = 'none';
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('scanBtn').innerHTML = '<i class="fas fa-search"></i> Qu√©t Chi Ti·∫øt';
            document.getElementById('scanBtn').style.opacity = "1";
            document.getElementById('scanBtn').style.cursor = "pointer";
        }
    </script>
</body>
</html>
