<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MES Defect Reporting - B√°o C√°o L·ªói</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Turnstile Script -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  
  <style>
    :root {
      /* Palette m√†u ƒê·ªè/Cam - C·∫£nh b√°o s·ª± c·ªë */
      --primary-gradient: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
      --accent-color: #dc2626;

      /* C√°c n√∫t ch·ª©c nƒÉng */
      --btn-load-bg: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      --btn-reset-bg: linear-gradient(135deg, #64748b 0%, #475569 100%);
      
      /* N·ªÅn */
      --bg-body: #e2e8f0; 
      --bg-card: #ffffff;
      
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border-color: #cbd5e1;
      
      --radius: 14px;
      --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%);
      color: var(--text-main);
      margin: 0; padding: 0; min-height: 100vh;
    }

    /* Navbar */
    .navbar {
      background: #7f1d1d;
      color: white;
      padding: 1rem 2rem;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: sticky; top: 0; z-index: 100;
    }
    
    .brand {
      font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px;
      display: flex; align-items: center; gap: 12px; color: #fef2f2;
    }
    
    .status-badge {
      font-size: 0.85rem;
      background: rgba(254, 202, 202, 0.15);
      color: #fca5a5;
      padding: 6px 16px; border-radius: 99px; font-weight: 600;
      border: 1px solid rgba(254, 202, 202, 0.2);
    }

    /* Layout */
    .container {
      max-width: 1200px;
      margin: 30px auto; padding: 0 20px;
      display: grid; grid-template-columns: 1fr 1fr; gap: 25px;
    }

    @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      padding: 24px; margin-bottom: 24px;
      border: 1px solid white;
      height: fit-content;
    }

    .card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px; padding-bottom: 12px;
      border-bottom: 2px solid #f1f5f9;
    }
    .card-title {
      font-size: 1.1rem; font-weight: 700; color: #7f1d1d;
      display: flex; align-items: center; gap: 8px;
    }

    /* Inputs */
    .form-row { display: flex; gap: 15px; }
    .form-col { flex: 1; }
    .form-group { margin-bottom: 18px; }
    
    label {
      display: block; margin-bottom: 6px;
      font-weight: 600; font-size: 0.9rem; color: #475569;
    }
    input, textarea, select {
      width: 100%; padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 10px; font-size: 0.95rem; font-family: inherit;
      background: #f8fafc; transition: all 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #ef4444; background: white;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
    }
    textarea { min-height: 100px; resize: vertical; }

    /* Search Box Styles */
    .search-wrapper { position: relative; margin-bottom: 10px; }
    .search-wrapper input { padding-left: 38px; border-color: #e2e8f0; }
    .search-wrapper input:disabled { background-color: #f1f5f9; cursor: not-allowed; }
    .search-icon {
      position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
      color: #94a3b8; font-size: 1rem; pointer-events: none;
    }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 12px 20px; border-radius: 10px; font-weight: 600;
      cursor: pointer; border: none; color: white;
      transition: all 0.2s ease; font-size: 0.95rem; width: 100%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn:hover { transform: translateY(-2px); filter: brightness(110%); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(100%); }

    .btn-submit { background: var(--primary-gradient); font-size: 1.1rem; }
    .btn-load { background: var(--btn-load-bg); }
    .btn-reset { background: var(--btn-reset-bg); }
    .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; }

    /* Defect List Area */
    .defect-container {
      max-height: 300px; overflow-y: auto;
      border: 2px solid #e2e8f0; border-radius: 10px;
      background: #f8fafc; padding: 5px;
    }
    .defect-item {
      padding: 12px; margin-bottom: 4px;
      border-radius: 8px; cursor: pointer;
      transition: all 0.2s; border: 1px solid transparent;
      display: flex; justify-content: space-between; align-items: center;
    }
    .defect-item:hover { background: #fee2e2; border-color: #fecaca; }
    .defect-item.selected {
      background: #fef2f2; border-color: #ef4444;
      color: #b91c1c; font-weight: 700;
      box-shadow: inset 0 0 0 1px #ef4444;
    }
    .defect-item.selected::after { content: '‚úì'; font-weight: bold; }
    .defect-item.hidden { display: none !important; }

    /* Image Preview */
    .image-upload-box {
      border: 2px dashed #cbd5e1; border-radius: 10px;
      padding: 20px; text-align: center;
      background: #f8fafc; cursor: pointer;
      transition: all 0.2s; position: relative;
    }
    .image-upload-box:hover { border-color: #ef4444; background: #fff; }
    #imagePreview {
      max-width: 100%; max-height: 250px;
      border-radius: 8px; margin-top: 10px;
      display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    input[type="file"] { display: none; }

    /* Logs */
    .log-container {
      background: #1e293b; color: #e2e8f0;
      padding: 15px; border-radius: 12px;
      font-family: 'Consolas', monospace; font-size: 0.85rem;
      height: 200px; overflow-y: auto;
      margin-top: 20px;
      white-space: pre-wrap;
    }
    .log-entry { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .log-success { color: #4ade80; }
    .log-error { color: #f87171; }
    .log-info { color: #60a5fa; }
    .log-detail { color: #e2e8f0; font-size: 0.8em; margin-left: 15px; opacity: 0.8; }

    /* Floating Turnstile Widget */
    .turnstile-floating {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 999;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.2);
      max-width: 320px;
      transition: all 0.3s ease;
    }

    .turnstile-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(239, 68, 68, 0.1);
    }

    .turnstile-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #7f1d1d;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .turnstile-status {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 500;
    }

    .status-pending {
      background: rgba(245, 158, 11, 0.1);
      color: #d97706;
    }

    .status-success {
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
    }

    .status-error {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    .turnstile-minimize {
      background: none;
      border: none;
      color: #64748b;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      font-size: 1rem;
    }

    .turnstile-minimize:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .turnstile-minimized {
      width: 40px;
      height: 40px;
      padding: 0;
      overflow: hidden;
      cursor: pointer;
    }

    .turnstile-minimized .turnstile-header {
      display: none;
    }

    .turnstile-minimized .cf-turnstile {
      display: none;
    }

    .turnstile-minimized .turnstile-note {
      display: none;
    }

    .turnstile-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
      color: white;
      border-radius: 8px;
      font-size: 1.2rem;
    }

    .turnstile-note {
      font-size: 0.7rem;
      color: #64748b;
      text-align: center;
      margin-top: 8px;
      opacity: 0.8;
      line-height: 1.3;
    }

    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    .pulse-btn { animation: pulse-red 2s infinite; }
    
    .input-wrapper { display: flex; gap: 5px; }

    /* Responsive for mobile */
    @media (max-width: 768px) {
      .turnstile-floating {
        bottom: 10px;
        right: 10px;
        max-width: 280px;
      }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <div class="brand">
      <span>üö® MES DEFECT REPORT</span>
    </div>
    <div class="status-badge">System Online</div>
  </div>

  <div class="container">
    
    <!-- Left Column: Input Info -->
    <div class="left-col">
      
      <!-- Config -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚öôÔ∏è C·∫•u H√¨nh S·∫£n Xu·∫•t</div>
        </div>
        
        <!-- API Key -->
        <div class="form-group">
          <label>API Key</label>
          <input type="password" id="apiKey" placeholder="Nh·∫≠p kh√≥a b·∫£o m·∫≠t..." value="">
        </div>

        <!-- Factory & Date Row -->
        <div class="form-row">
          <div class="form-col">
            <label>Factory</label>
            <input list="factoryOptions" id="factory" value="P2C1" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p...">
            <datalist id="factoryOptions">
              <option value="P2A1"></option>
              <option value="P2B1"></option>
              <option value="P2C1"></option>
              <option value="P2D1"></option>
            </datalist>
          </div>
          <div class="form-col">
            <label>Date</label>
            <input type="date" id="dateSelect">
          </div>
        </div>

        <!-- Package ID -->
        <div class="form-group">
          <label>Package ID (M√£ l√¥)</label>
          <div class="input-wrapper">
             <input type="text" id="package" list="packageList" placeholder="Nh·∫≠p Key r·ªìi nh·∫•n üîÑ ƒë·ªÉ t·∫£i..." autocomplete="off">
             <button id="btnReloadPkg" class="btn btn-load btn-sm" style="width: auto;" title="T·∫£i l·∫°i danh s√°ch g√≥i">üîÑ</button>
          </div>
          <datalist id="packageList">
             <!-- Javascript s·∫Ω ƒëi·ªÅn d·ªØ li·ªáu v√†o ƒë√¢y -->
          </datalist>
          <small style="color: #64748b; font-size: 0.8rem;">Th√¥ng tin: Line | Style Name | Target | Factory</small>
        </div>

        <!-- Operation -->
        <div class="form-group">
          <label>Operation Serial (C√¥ng ƒëo·∫°n)</label>
          <input type="number" id="opserial" value="0" placeholder="0">
        </div>
      </div>

      <!-- Defect Selection -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚ö†Ô∏è Ch·ªçn Lo·∫°i L·ªói</div>
          <button id="loadDefects" class="btn btn-load btn-sm">üì• T·∫£i Danh S√°ch</button>
        </div>
        
        <div class="search-wrapper">
          <span class="search-icon">üîç</span>
          <input type="text" id="defectSearch" placeholder="L·ªçc nhanh t√™n l·ªói (vd: Keo, Tr√†n...)" disabled>
        </div>
        
        <div id="defectsContainer" class="defect-container">
          <div style="text-align:center; padding: 20px; color: #94a3b8;">
            Vui l√≤ng nh·∫•n n√∫t "T·∫£i Danh S√°ch" ƒë·ªÉ ch·ªçn l·ªói.
          </div>
        </div>
        <input type="hidden" id="selectedDefectCode" value="">
        <input type="hidden" id="selectedDefectCat" value="">
      </div>

    </div>

    <!-- Right Column: Details & Action -->
    <div class="right-col">
      
      <!-- Evidence -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üì∏ B·∫±ng Ch·ª©ng & Ghi Ch√∫</div>
        </div>

        <div class="form-group">
          <label>H√¨nh ·∫£nh minh h·ªça</label>
          <div class="image-upload-box" onclick="document.getElementById('image').click()">
            <div id="uploadPlaceholder">
              <span style="font-size: 2rem;">üì∑</span><br>
              <span style="color: #64748b; font-size: 0.9rem;">Nh·∫•n ƒë·ªÉ t·∫£i ·∫£nh ho·∫∑c Ch·ª•p ·∫£nh</span>
            </div>
            <img id="imagePreview" alt="Preview">
            <input type="file" id="image" accept="image/*">
          </div>
          <div style="text-align: right; margin-top: 5px;">
            <button id="clearImage" class="btn btn-reset btn-sm" style="display:none;">X√≥a ·∫£nh</button>
          </div>
        </div>
        
        <div class="form-group">
          <label>Ghi ch√∫ chi ti·∫øt</label>
          <textarea id="comment" placeholder="M√¥ t·∫£ c·ª• th·ªÉ v·ªÅ l·ªói..."></textarea>
        </div>
      </div>

      <!-- Submit Action -->
      <button id="submitReport" class="btn btn-submit pulse-btn" disabled>
        üöÄ G·ª¨I B√ÅO C√ÅO L·ªñI
      </button>

      <!-- Logs -->
      <div class="log-container" id="log">
        <div class="log-entry">H·ªá th·ªëng kh·ªüi ƒë·ªông...</div>
      </div>

    </div>
  </div>

  <!-- Floating Turnstile Widget -->
  <div id="turnstileWidget" class="turnstile-floating">
    <div class="turnstile-header">
      <div class="turnstile-title">
        <span>üîê</span>
        <span>X√°c Th·ª±c B·∫£o M·∫≠t</span>
      </div>
      <div id="turnstileStatus" class="turnstile-status status-pending">
        ƒêang ch·ªù
      </div>
      <button id="turnstileToggle" class="turnstile-minimize" title="Thu g·ªçn">
        ‚ûñ
      </button>
    </div>
    
    <div class="cf-turnstile" 
         data-sitekey="0x4AAAAAACKJOBIKvTV3je0V"
         data-callback="onTurnstileSuccess"
         data-error-callback="onTurnstileError"
         data-expired-callback="onTurnstileExpired"
         data-theme="light">
    </div>
    
    <div class="turnstile-note">
      B·∫£o v·ªá h·ªá th·ªëng kh·ªèi spam ‚Ä¢ T·ª± ƒë·ªông ·∫©n khi ƒë√£ x√°c th·ª±c
    </div>
  </div>

  <script>
  // ==========================================
  // üîí C·∫§U H√åNH H·ªÜ TH·ªêNG
  // ==========================================
  const DEFECT_API = "https://defect-management.chiscoong-cloudflare-com.workers.dev";
  const PACKAGE_API = "https://today-package.chiscoong-cloudflare-com.workers.dev/api/packages";
  
  // Variables
  let selectedDefectData = null;
  let currentPackageDataList = [];
  let turnstileToken = null;
  let isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  let turnstileMinimized = false;

  // ==========================================
  // üõ†Ô∏è UTILS & LOGGER
  // ==========================================
  function appendLog(message, type = 'info') {
    const logEl = document.getElementById("log");
    const timeStr = new Date().toLocaleTimeString('vi-VN', { hour12: false });
    let colorClass = '';
    
    if (type === 'error') colorClass = 'log-error';
    else if (type === 'success') colorClass = 'log-success';
    else if (type === 'detail') colorClass = 'log-detail';

    const div = document.createElement('div');
    div.className = `log-entry ${colorClass}`;
    
    if (type === 'detail') {
        div.innerHTML = `${message}`;
    } else {
        div.innerHTML = `<span style="color: #64748b">[${timeStr}]</span> <span class="${colorClass}">${message}</span>`;
    }
    
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // ==========================================
  // üîê TURNSTILE FLOATING WIDGET
  // ==========================================

  // Toggle minimize/maximize widget
  document.getElementById('turnstileToggle').addEventListener('click', function() {
    const widget = document.getElementById('turnstileWidget');
    const toggleBtn = this;
    
    if (turnstileMinimized) {
      // Maximize
      widget.classList.remove('turnstile-minimized');
      widget.innerHTML = `
        <div class="turnstile-header">
          <div class="turnstile-title">
            <span>üîê</span>
            <span>X√°c Th·ª±c B·∫£o M·∫≠t</span>
          </div>
          <div id="turnstileStatus" class="turnstile-status ${turnstileToken ? 'status-success' : 'status-pending'}">
            ${turnstileToken ? 'ƒê√£ x√°c th·ª±c' : 'ƒêang ch·ªù'}
          </div>
          <button id="turnstileToggle" class="turnstile-minimize" title="Thu g·ªçn">
            ‚ûñ
          </button>
        </div>
        <div class="cf-turnstile" 
             data-sitekey="0x4AAAAAACKJOBIKvTV3je0V"
             data-callback="onTurnstileSuccess"
             data-error-callback="onTurnstileError"
             data-expired-callback="onTurnstileExpired"
             data-theme="light">
        </div>
        <div class="turnstile-note">
          B·∫£o v·ªá h·ªá th·ªëng kh·ªèi spam ‚Ä¢ T·ª± ƒë·ªông ·∫©n khi ƒë√£ x√°c th·ª±c
        </div>
      `;
      
      // Re-attach event listener
      setTimeout(() => {
        document.getElementById('turnstileToggle').addEventListener('click', arguments.callee);
      }, 100);
      
      turnstileMinimized = false;
    } else {
      // Minimize
      widget.classList.add('turnstile-minimized');
      widget.innerHTML = `
        <div class="turnstile-icon" title="Nh·∫•n ƒë·ªÉ m·ªü x√°c th·ª±c">
          üîê
        </div>
      `;
      
      // Click icon to maximize
      widget.querySelector('.turnstile-icon').addEventListener('click', function() {
        turnstileMinimized = false;
        widget.classList.remove('turnstile-minimized');
        widget.innerHTML = `
          <div class="turnstile-header">
            <div class="turnstile-title">
              <span>üîê</span>
              <span>X√°c Th·ª±c B·∫£o M·∫≠t</span>
            </div>
            <div id="turnstileStatus" class="turnstile-status ${turnstileToken ? 'status-success' : 'status-pending'}">
              ${turnstileToken ? 'ƒê√£ x√°c th·ª±c' : 'ƒêang ch·ªù'}
            </div>
            <button id="turnstileToggle" class="turnstile-minimize" title="Thu g·ªçn">
              ‚ûñ
            </button>
          </div>
          <div class="cf-turnstile" 
               data-sitekey="0x4AAAAAACKJOBIKvTV3je0V"
               data-callback="onTurnstileSuccess"
               data-error-callback="onTurnstileError"
               data-expired-callback="onTurnstileExpired"
               data-theme="light">
          </div>
          <div class="turnstile-note">
            B·∫£o v·ªá h·ªá th·ªëng kh·ªèi spam ‚Ä¢ T·ª± ƒë·ªông ·∫©n khi ƒë√£ x√°c th·ª±c
          </div>
        `;
        
        // Re-attach event listener
        setTimeout(() => {
          document.getElementById('turnstileToggle').addEventListener('click', arguments.callee);
        }, 100);
      });
      
      turnstileMinimized = true;
    }
  });

  // Auto-hide widget after successful verification
  function autoHideWidget() {
    setTimeout(() => {
      if (turnstileToken && !turnstileMinimized) {
        const toggleBtn = document.getElementById('turnstileToggle');
        if (toggleBtn) toggleBtn.click();
      }
    }, 3000); // Hide after 3 seconds
  }

  // Callback khi Turnstile th√†nh c√¥ng
  window.onTurnstileSuccess = function(token) {
    if (turnstileToken) return; // Ch·ªâ x·ª≠ l√Ω m·ªôt l·∫ßn
    turnstileToken = token;
    
    // Update status
    const statusEl = document.getElementById('turnstileStatus');
    if (statusEl) {
      statusEl.textContent = 'ƒê√£ x√°c th·ª±c';
      statusEl.className = 'turnstile-status status-success';
    }
    
    // Enable submit button
    document.getElementById('submitReport').disabled = false;
    document.getElementById('submitReport').innerHTML = 'üöÄ G·ª¨I B√ÅO C√ÅO L·ªñI';
    
    appendLog("‚úÖ ƒê√£ x√°c th·ª±c b·∫£o m·∫≠t", "success");
    
    // Auto-hide widget
    autoHideWidget();
  };

  // Callback khi c√≥ l·ªói
  window.onTurnstileError = function() {
    const statusEl = document.getElementById('turnstileStatus');
    if (statusEl) {
      statusEl.textContent = 'L·ªói x√°c th·ª±c';
      statusEl.className = 'turnstile-status status-error';
    }
    
    document.getElementById('submitReport').disabled = true;
    turnstileToken = null;
    
    appendLog("‚ùå L·ªói x√°c th·ª±c", "error");
  };

  // Callback khi token h·∫øt h·∫°n
  window.onTurnstileExpired = function() {
    const statusEl = document.getElementById('turnstileStatus');
    if (statusEl) {
      statusEl.textContent = 'ƒê√£ h·∫øt h·∫°n';
      statusEl.className = 'turnstile-status status-error';
    }
    
    document.getElementById('submitReport').disabled = true;
    turnstileToken = null;
    
    appendLog("‚ö†Ô∏è Phi√™n x√°c th·ª±c h·∫øt h·∫°n", "error");
  };

  // ==========================================
  // üì¶ PACKAGE MANAGEMENT - GI·ªÆ NGUY√äN
  // ==========================================
  
  function setTodayDate() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById('dateSelect').value = `${yyyy}-${mm}-${dd}`;
  }

  function getApiDateString() {
    const dateVal = document.getElementById('dateSelect').value;
    if(!dateVal) return "";
    return dateVal.replace(/-/g, '');
  }

  async function fetchPackages() {
    const factory = document.getElementById('factory').value.trim();
    const dateStr = getApiDateString();
    const apiKey = document.getElementById('apiKey').value.trim();

    if (!apiKey) {
        appendLog("‚ö†Ô∏è Vui l√≤ng nh·∫≠p API Key ƒë·ªÉ t·∫£i g√≥i.", "error");
        document.getElementById('apiKey').focus();
        return; 
    }
    if (!factory || !dateStr) {
        appendLog("‚ö†Ô∏è Vui l√≤ng ch·ªçn Factory v√† Date.", "error");
        return;
    }

    const btnReload = document.getElementById('btnReloadPkg');
    const inputPkg = document.getElementById('package');
    const datalist = document.getElementById('packageList');

    try {
        btnReload.disabled = true;
        btnReload.textContent = "‚è≥";
        inputPkg.placeholder = "ƒêang t·∫£i d·ªØ li·ªáu...";
        
        const url = `${PACKAGE_API}?factory=${encodeURIComponent(factory)}&fromDate=${dateStr}&withDetails=true&apikey=${encodeURIComponent(apiKey)}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
            const errJson = await response.json().catch(() => ({}));
            throw new Error(errJson.error || `L·ªói HTTP ${response.status}`);
        }
        
        const rawData = await response.json();
        
        let list = [];
        if (rawData.data && Array.isArray(rawData.data.packages)) {
            list = rawData.data.packages;
        } else if (Array.isArray(rawData)) {
            list = rawData;
        } else if (rawData.data && Array.isArray(rawData.data)) {
            list = rawData.data;
        }
        
        currentPackageDataList = list || [];
        datalist.innerHTML = '';

        if (currentPackageDataList.length === 0) {
            appendLog(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y g√≥i n√†o cho ${factory} ng√†y ${dateStr}.`, 'error');
        } else {
            currentPackageDataList.forEach(pkg => {
                const option = document.createElement('option');
                
                option.value = pkg.packageId; 
                
                const line = pkg.lineName || "?";
                const style = pkg.styleText || "N/A";
                const target = pkg.target || "0";
                const fact = pkg.factory || "";
                
                const displayText = `${line} | ${style} | ${target} | ${fact}`;
                
                option.label = displayText;
                option.textContent = displayText;
                
                datalist.appendChild(option);
            });
            appendLog(`‚úÖ ƒê√£ t·∫£i ${currentPackageDataList.length} g√≥i s·∫£n xu·∫•t.`, 'success');
        }

    } catch (e) {
        appendLog(`‚ùå L·ªói t·∫£i Package: ${e.message}`, 'error');
        console.error(e);
        currentPackageDataList = []; 
    } finally {
        btnReload.disabled = false;
        btnReload.textContent = "üîÑ";
        inputPkg.placeholder = "Nh·∫≠p ho·∫∑c ch·ªçn g√≥i...";
    }
  }

  // S·ª± ki·ªán ch·ªçn Package -> Log chi ti·∫øt
  document.getElementById('package').addEventListener('input', function(e) {
      const val = e.target.value.trim();
      if (!val) return;

      const pkgDetails = currentPackageDataList.find(p => p.packageId === val);

      if (pkgDetails) {
          appendLog(`üîπ ƒê√£ ch·ªçn: ${pkgDetails.packageId}`, 'info');
          let detailsLog = "";
          
          const fields = [
              { key: 'lineName', label: 'Line' },
              { key: 'styleText', label: 'Style' },
              { key: 'target', label: 'Target' },
              { key: 'status', label: 'Status' }
          ];

          fields.forEach(field => {
              if (pkgDetails[field.key]) {
                  detailsLog += `   ‚Ä¢ ${field.label}: ${pkgDetails[field.key]}\n`;
              }
          });
          
          appendLog(detailsLog, 'detail');
      }
  });

  document.getElementById('factory').addEventListener('change', () => {
      if(document.getElementById('apiKey').value) fetchPackages();
  });
  
  document.getElementById('dateSelect').addEventListener('change', () => {
      if(document.getElementById('apiKey').value) fetchPackages();
  });
  
  document.getElementById('btnReloadPkg').addEventListener('click', fetchPackages);

  // ==========================================
  // üñºÔ∏è IMAGE & UI LOGIC - GI·ªÆ NGUY√äN
  // ==========================================
  const imageInput = document.getElementById('image');
  const imagePreview = document.getElementById('imagePreview');
  const uploadPlaceholder = document.getElementById('uploadPlaceholder');
  const clearImageBtn = document.getElementById('clearImage');

  imageInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'inline-block';
        uploadPlaceholder.style.display = 'none';
        clearImageBtn.style.display = 'inline-block';
        appendLog(`üì∏ ƒê√£ ch·ªçn ·∫£nh: ${file.name}`);
      };
      reader.readAsDataURL(file);
    }
  });

  clearImageBtn.addEventListener('click', function() {
    imageInput.value = '';
    imagePreview.style.display = 'none';
    uploadPlaceholder.style.display = 'block';
    clearImageBtn.style.display = 'none';
    appendLog("ƒê√£ x√≥a ·∫£nh ƒë√£ ch·ªçn.");
  });

  const defectSearch = document.getElementById('defectSearch');
  defectSearch.addEventListener('input', function(e) {
    const filterText = e.target.value.toLowerCase().trim();
    const items = document.querySelectorAll('.defect-item');
    items.forEach(item => {
      const text = item.textContent.toLowerCase();
      item.classList.toggle('hidden', !text.includes(filterText));
    });
  });

  // ==========================================
  // üì• T·∫¢I DANH S√ÅCH L·ªñI - GI·ªÆ NGUY√äN
  // ==========================================
  document.getElementById('loadDefects').addEventListener('click', async function() {
    const apiKey = document.getElementById('apiKey').value.trim();
    const pkg = document.getElementById('package').value.trim();
    
    if (!apiKey) return alert('Vui l√≤ng nh·∫≠p API Key!');
    if (!pkg) return alert('Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p Package ID!');

    const btn = this;
    const container = document.getElementById('defectsContainer');
    
    try {
      btn.textContent = '‚è≥ ƒêang t·∫£i...';
      btn.disabled = true;
      defectSearch.value = '';
      defectSearch.disabled = true;
      
      appendLog(`ƒêang l·∫•y danh s√°ch l·ªói cho g√≥i ${pkg}...`);

      const url = `${DEFECT_API}/api/defects?package=${encodeURIComponent(pkg)}&apikey=${encodeURIComponent(apiKey)}`;
      const response = await fetch(url);
      const data = await response.json();

      if (!response.ok) throw new Error(data.error || 'L·ªói t·∫£i danh s√°ch');

      const defects = data.data || [];
      
      if(defects.length === 0) {
        container.innerHTML = '<div style="padding:10px; text-align:center">Kh√¥ng t√¨m th·∫•y m√£ l·ªói n√†o.</div>';
      } else {
        container.innerHTML = '';
        defects.forEach(defect => {
          const div = document.createElement('div');
          div.className = 'defect-item';
          div.textContent = defect.display;
          div.onclick = () => selectDefect(div, defect);
          container.appendChild(div);
        });
        
        defectSearch.disabled = false;
        defectSearch.focus();
        appendLog(`‚úÖ ƒê√£ t·∫£i ${defects.length} lo·∫°i l·ªói.`, 'success');
      }

    } catch (error) {
      appendLog(`‚ùå L·ªói t·∫£i Defects: ${error.message}`, 'error');
      container.innerHTML = `<div style="color:red; padding:10px;">L·ªói: ${error.message}</div>`;
    } finally {
      btn.textContent = 'üì• T·∫£i Danh S√°ch';
      btn.disabled = false;
    }
  });

  function selectDefect(element, defect) {
    document.querySelectorAll('.defect-item').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    selectedDefectData = defect;
    appendLog(`ƒê√£ ch·ªçn l·ªói: ${defect.display}`);
  }

  // ==========================================
  // üöÄ SUBMIT REPORT - C·∫¨P NH·∫¨T V·ªöI TURNSTILE
  // ==========================================
  document.getElementById('submitReport').addEventListener('click', async function() {
    const apiKey = document.getElementById('apiKey').value.trim();
    const pkg = document.getElementById('package').value.trim();
    const opserial = document.getElementById('opserial').value.trim();
    const comment = document.getElementById('comment').value.trim();
    const imgFile = imageInput.files[0];

    if (!apiKey) return alert('Thi·∫øu API Key!');
    if (!pkg) return alert('Thi·∫øu Package ID!');
    if (!selectedDefectData) return alert('‚ö†Ô∏è Vui l√≤ng CH·ªåN LO·∫†I L·ªñI tr∆∞·ªõc khi g·ª≠i!');
    
    // Ki·ªÉm tra Turnstile token
    if (!turnstileToken && !isLocalhost) {
      alert('‚ö†Ô∏è Vui l√≤ng ho√†n th√†nh x√°c th·ª±c b·∫£o m·∫≠t tr∆∞·ªõc khi g·ª≠i!');
      
      // Auto-expand widget if minimized
      if (turnstileMinimized) {
        document.querySelector('.turnstile-icon').click();
      }
      return;
    }

    if (!confirm(`X√°c nh·∫≠n b√°o c√°o l·ªói: "${selectedDefectData.display}" cho g√≥i ${pkg}?`)) return;

    const btn = this;
    
    try {
      btn.innerHTML = '‚è≥ ƒêANG G·ª¨I...';
      btn.disabled = true;
      document.body.style.cursor = 'wait';

      const formData = new FormData();
      formData.append('package', pkg);
      formData.append('opserial', opserial || '0');
      formData.append('defect_cat', selectedDefectData.cat_code);
      formData.append('defect_code', selectedDefectData.defect_code);
      formData.append('comment', comment);
      
      // Ch·ªâ th√™m Turnstile token khi kh√¥ng ph·∫£i localhost
      if (!isLocalhost) {
        formData.append('cf-turnstile-response', turnstileToken);
      }
      
      if (imgFile) formData.append('image', imgFile);

      const url = `${DEFECT_API}/api/report?apikey=${encodeURIComponent(apiKey)}`;
      
      const response = await fetch(url, { method: 'POST', body: formData });
      const result = await response.json();

      if (!response.ok) throw new Error(result.error || 'G·ª≠i th·∫•t b·∫°i');

      appendLog(`‚úÖ B√ÅO C√ÅO TH√ÄNH C√îNG! ID: ${result.defect_id}`, 'success');
      alert(`‚úÖ G·ª≠i th√†nh c√¥ng!\nM√£ l·ªói: ${result.defect_id}`);

      // Reset form
      document.getElementById('comment').value = '';
      clearImageBtn.click();
      document.querySelectorAll('.defect-item').forEach(el => el.classList.remove('selected'));
      selectedDefectData = null;
      
      // Reset Turnstile (ch·ªâ khi kh√¥ng ph·∫£i localhost)
      if (!isLocalhost) {
        turnstileToken = null;
        const statusEl = document.getElementById('turnstileStatus');
        if (statusEl) {
          statusEl.textContent = 'ƒêang ch·ªù';
          statusEl.className = 'turnstile-status status-pending';
        }
        document.getElementById('submitReport').disabled = true;
      }

    } catch (error) {
      appendLog(`‚ùå G·ª≠i th·∫•t b·∫°i: ${error.message}`, 'error');
      alert(`‚ùå L·ªói: ${error.message}`);
    } finally {
      btn.innerHTML = 'üöÄ G·ª¨I B√ÅO C√ÅO L·ªñI';
      btn.disabled = false;
      document.body.style.cursor = 'default';
    }
  });

  // ==========================================
  // üèÅ INITIALIZATION
  // ==========================================
  document.addEventListener('DOMContentLoaded', () => {
      setTodayDate();
      appendLog("üìù Vui l√≤ng nh·∫≠p API Key r·ªìi nh·∫•n n√∫t üîÑ ƒë·ªÉ t·∫£i g√≥i.", "info");
      
      // T·ª± ƒë·ªông enable n√∫t submit n·∫øu l√† localhost
      if (isLocalhost) {
        document.getElementById('submitReport').disabled = false;
        document.getElementById('submitReport').innerHTML = 'üöÄ G·ª¨I B√ÅO C√ÅO L·ªñI';
        turnstileToken = 'LOCAL_MODE_BYPASS';
        
        // ·∫®n Turnstile widget tr√™n localhost
        document.getElementById('turnstileWidget').style.display = 'none';
        appendLog("üîß ƒêang ch·∫°y ·ªü ch·∫ø ƒë·ªô localhost - Turnstile ƒë√£ t·∫Øt", "info");
      }
  });

  </script>
</body>
</html>
