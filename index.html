<!DOCTYPE html>
<html>
<head>
    <title>MES API Mini Tester</title>
    <meta charset="UTF-8">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0; padding: 20px; background: #f5f5f5; 
        }
        .container { 
            max-width: 800px; margin: 0 auto; background: white; 
            border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        input, select, button { 
            width: 100%; padding: 10px; border: 1px solid #ddd; 
            border-radius: 5px; font-size: 14px;
        }
        button { 
            background: #4CAF50; color: white; border: none; 
            cursor: pointer; font-weight: 600; margin-top: 10px;
        }
        button:hover { background: #45a049; }
        .result { 
            margin-top: 20px; padding: 15px; border-radius: 5px; 
            background: #f8f9fa; border: 1px solid #e9ecef;
        }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .loading { color: #6c757d; text-align: center; padding: 20px; }
        .data-table { 
            width: 100%; border-collapse: collapse; margin-top: 10px;
        }
        .data-table th, .data-table td { 
            padding: 8px; text-align: left; border-bottom: 1px solid #ddd;
        }
        .status { 
            display: inline-block; padding: 2px 8px; border-radius: 3px;
            font-size: 12px; font-weight: 600;
        }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß MES API Mini Tester</h1>
        
        <div class="input-group">
            <label>MES API URL:</label>
            <input type="text" id="apiUrl" value="http://203.113.151.219:8888">
        </div>
        
        <div class="input-group">
            <label>Test Type:</label>
            <select id="testType">
                <option value="packages">Test Packages API</option>
                <option value="styles">Test Styles API</option>
                <option value="image">Test Image Server</option>
                <option value="all">Test All</option>
            </select>
        </div>
        
        <div class="input-group" id="styleCodeGroup">
            <label>Style Code:</label>
            <input type="text" id="styleCode" value="ONR0112" placeholder="Enter style code">
        </div>
        
        <button onclick="runTest()">‚ñ∂Ô∏è Run Test</button>
        
        <div id="loading" class="loading" style="display: none;">
            <p>Testing... Please wait ‚è≥</p>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        // Proxy configuration
        const PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ];
        
        let currentProxy = 0;
        
        async function runTest() {
            const testType = document.getElementById('testType').value;
            const apiUrl = document.getElementById('apiUrl').value;
            const styleCode = document.getElementById('styleCode').value.toUpperCase();
            
            showLoading(true);
            clearResult();
            
            try {
                let result;
                
                switch(testType) {
                    case 'packages':
                        result = await testPackagesAPI(apiUrl, styleCode);
                        break;
                    case 'styles':
                        result = await testStylesAPI(apiUrl, styleCode);
                        break;
                    case 'image':
                        result = await testImageServer(styleCode);
                        break;
                    case 'all':
                        result = await testAll(apiUrl, styleCode);
                        break;
                }
                
                displayResult(result);
            } catch (error) {
                displayError(error);
            } finally {
                showLoading(false);
            }
        }
        
        async function testPackagesAPI(apiUrl, styleCode) {
            const endpoint = `/packages?stylecode=${styleCode}&pagesize=5`;
            const result = await fetchViaProxy(apiUrl + endpoint);
            
            return {
                title: 'üì¶ Packages API Test',
                success: result.success,
                data: result.data,
                url: apiUrl + endpoint
            };
        }
        
        async function testStylesAPI(apiUrl, styleCode) {
            const endpoint = `/buyerstylecodes?stylecode=${styleCode}`;
            const result = await fetchViaProxy(apiUrl + endpoint);
            
            return {
                title: 'üëï Styles API Test',
                success: result.success,
                data: result.data,
                url: apiUrl + endpoint
            };
        }
        
        async function testImageServer(styleCode) {
            const buyer = styleCode.substring(0, 3);
            const results = [];
            
            // Test first 3 images
            for (let i = 1; i <= 3; i++) {
                const imageUrl = `http://203.113.151.204:8080/PKPDM/style/${buyer}/${styleCode}/Images/${styleCode}${i}.jpg`;
                const exists = await checkImageExists(imageUrl);
                
                results.push({
                    image: `${styleCode}${i}.jpg`,
                    url: imageUrl,
                    exists: exists
                });
            }
            
            return {
                title: 'üñºÔ∏è Image Server Test',
                success: results.some(r => r.exists),
                results: results
            };
        }
        
        async function testAll(apiUrl, styleCode) {
            const [packagesResult, stylesResult, imageResult] = await Promise.all([
                testPackagesAPI(apiUrl, styleCode),
                testStylesAPI(apiUrl, styleCode),
                testImageServer(styleCode)
            ]);
            
            return {
                title: 'üéØ Comprehensive Test',
                packages: packagesResult,
                styles: stylesResult,
                images: imageResult,
                success: packagesResult.success && stylesResult.success && imageResult.success
            };
        }
        
        async function fetchViaProxy(url) {
            // Try each proxy
            for (let i = 0; i < PROXIES.length; i++) {
                const proxyIndex = (currentProxy + i) % PROXIES.length;
                const proxy = PROXIES[proxyIndex];
                const proxiedUrl = proxy + encodeURIComponent(url);
                
                try {
                    console.log(`Trying proxy ${proxyIndex + 1}: ${proxy}`);
                    const response = await fetch(proxiedUrl, { 
                        signal: AbortSignal.timeout(5000) 
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        currentProxy = proxyIndex; // Remember working proxy
                        
                        return { success: true, data };
                    }
                } catch (error) {
                    console.log(`Proxy ${proxyIndex + 1} failed:`, error.message);
                    continue;
                }
            }
            
            return { success: false, error: 'All proxies failed' };
        }
        
        function checkImageExists(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url + '?t=' + Date.now(); // Cache bust
                setTimeout(() => resolve(false), 3000);
            });
        }
        
        function displayResult(result) {
            const container = document.getElementById('result');
            let html = `<div class="${result.success ? 'success' : 'error'} result">`;
            
            html += `<h3>${result.title}</h3>`;
            
            if (result.url) {
                html += `<p><strong>URL:</strong> ${result.url}</p>`;
            }
            
            html += `<p><strong>Status:</strong> <span class="status ${result.success ? 'online' : 'offline'}">${result.success ? '‚úÖ SUCCESS' : '‚ùå FAILED'}</span></p>`;
            
            if (result.data) {
                html += `<p><strong>Data:</strong> ${JSON.stringify(result.data).substring(0, 300)}...</p>`;
            }
            
            if (result.results) {
                html += `<table class="data-table"><tr><th>Image</th><th>Status</th></tr>`;
                result.results.forEach(r => {
                    html += `<tr>
                        <td>${r.image}</td>
                        <td><span class="status ${r.exists ? 'online' : 'offline'}">${r.exists ? '‚úÖ Found' : '‚ùå Not found'}</span></td>
                    </tr>`;
                });
                html += `</table>`;
            }
            
            if (result.packages && result.styles && result.images) {
                html += `<div style="margin-top: 20px;">`;
                html += `<p><strong>Packages API:</strong> ${result.packages.success ? '‚úÖ' : '‚ùå'}</p>`;
                html += `<p><strong>Styles API:</strong> ${result.styles.success ? '‚úÖ' : '‚ùå'}</p>`;
                html += `<p><strong>Image Server:</strong> ${result.images.success ? '‚úÖ' : '‚ùå'}</p>`;
                html += `</div>`;
            }
            
            html += `</div>`;
            container.innerHTML = html;
        }
        
        function displayError(error) {
            const container = document.getElementById('result');
            container.innerHTML = `
                <div class="error result">
                    <h3>‚ùå Test Failed</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Try:</p>
                    <ol>
                        <li>Check if backend server is accessible</li>
                        <li>Try different CORS proxy</li>
                        <li>Run from local file instead of HTTPS</li>
                    </ol>
                </div>
            `;
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function clearResult() {
            document.getElementById('result').innerHTML = '';
        }
        
        // Auto-run on page load
        window.onload = function() {
            setTimeout(runTest, 500);
        };
    </script>
</body>
</html>
