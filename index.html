<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES Image Finder - Production Ready</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0;
            min-height: 800px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .sidebar {
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding: 25px;
            overflow-y: auto;
        }
        
        .content {
            padding: 25px;
            background: white;
            overflow-y: auto;
        }
        
        .section-title {
            color: #333;
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .result-area {
            margin-top: 30px;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-card {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            background: white;
            border: 1px solid #e9ecef;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .image-card img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            display: block;
            background: #f8f9fa;
        }
        
        .image-info {
            padding: 15px;
        }
        
        .image-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1rem;
            word-break: break-word;
        }
        
        .image-meta {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 5px;
        }
        
        .status-found {
            background: #d4edda;
            color: #155724;
        }
        
        .status-not-found {
            background: #f8d7da;
            color: #721c24;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #dee2e6;
        }
        
        .info-card h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        
        .info-value {
            color: #212529;
            max-width: 60%;
            text-align: right;
            word-break: break-word;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-box {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin: 20px 0;
        }
        
        .success-box {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin: 20px 0;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .api-response {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            overflow: auto;
            max-height: 400px;
            margin-top: 20px;
        }
        
        .color-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        .proxy-status {
            background: #e8f4fd;
            border: 1px solid #b6d4fe;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        .proxy-status h4 {
            margin-top: 0;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è MES Image Finder - Production Ready</h1>
            <p class="subtitle">‚úÖ ƒê√£ test th√†nh c√¥ng v·ªõi CORS proxies | S·∫µn s√†ng deploy</p>
        </div>
        
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <h2 class="section-title">üîç T√¨m Ki·∫øm</h2>
                
                <div class="proxy-status">
                    <h4>‚úÖ System Status: READY</h4>
                    <p><strong>Primary Proxy:</strong> api.allorigins.win (8ms)</p>
                    <p><strong>Backup Proxy:</strong> api.codetabs.com</p>
                    <p><strong>Image Proxy:</strong> images.weserv.nl</p>
                </div>
                
                <div class="input-group">
                    <label for="searchType">Lo·∫°i t√¨m ki·∫øm</label>
                    <select id="searchType">
                        <option value="style">Theo Style Code</option>
                        <option value="package">Theo Package Code</option>
                        <option value="search">T√¨m ki·∫øm Style</option>
                    </select>
                </div>
                
                <div id="styleInput" class="input-group">
                    <label for="styleCode">Style Code</label>
                    <input type="text" id="styleCode" placeholder="VD: ONR0112" value="ONR0112">
                </div>
                
                <div id="packageInput" class="input-group" style="display: none;">
                    <label for="packageCode">Package Code</label>
                    <input type="text" id="packageCode" placeholder="M_ONR-0141_1_ONR0112RGL018002_01_02">
                </div>
                
                <div id="searchInput" class="input-group" style="display: none;">
                    <label for="searchQuery">T√¨m ki·∫øm Style</label>
                    <input type="text" id="searchQuery" placeholder="Nh·∫≠p t√™n style...">
                </div>
                
                <div class="btn-group">
                    <button id="searchBtn" class="btn">üîç T√¨m Ki·∫øm</button>
                    <button id="testAllBtn" class="btn btn-secondary">üß™ Test T·∫•t C·∫£ ·∫¢nh</button>
                </div>
                
                <div class="input-group" style="margin-top: 30px;">
                    <h3>üìä Th√¥ng Tin H·ªá Th·ªëng</h3>
                    <div class="info-item">
                        <span class="info-label">Proxy Status:</span>
                        <span class="info-value" style="color: #28a745;">‚óè Active</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Requests:</span>
                        <span id="requestCount" class="info-value">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Updated:</span>
                        <span id="lastUpdated" class="info-value">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="content">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="images">üñºÔ∏è ·∫¢nh</button>
                    <button class="tab-btn" data-tab="info">üìã Th√¥ng Tin</button>
                    <button class="tab-btn" data-tab="packages">üì¶ Packages</button>
                    <button class="tab-btn" data-tab="raw">üìÑ Raw Data</button>
                </div>
                
                <div id="loading" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>ƒêang t·∫£i d·ªØ li·ªáu t·ª´ MES API...</p>
                </div>
                
                <!-- Tab: Images -->
                <div id="tab-images" class="tab-content active">
                    <div id="imagesResult"></div>
                </div>
                
                <!-- Tab: Info -->
                <div id="tab-info" class="tab-content">
                    <div id="infoResult"></div>
                </div>
                
                <!-- Tab: Packages -->
                <div id="tab-packages" class="tab-content">
                    <div id="packagesResult"></div>
                </div>
                
                <!-- Tab: Raw Data -->
                <div id="tab-raw" class="tab-content">
                    <div id="rawResult"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION (TESTED & WORKING) ====================
        const CONFIG = {
            MES_BASE_URL: "http://203.113.151.219:8888",
            IMAGE_BASE_URL: "http://203.113.151.204:8080/PKPDM",
            
            // üî• PROXIES ƒê√É TEST TH√ÄNH C√îNG
            API_PROXIES: [
                'https://api.allorigins.win/raw?url=',      // ‚ö° Primary (8ms - tested)
                'https://api.codetabs.com/v1/proxy?quest='  // Backup (1.3s - tested)
            ],
            
            IMAGE_PROXIES: [
                'https://images.weserv.nl/?url=',           // Primary image proxy
                'https://corsproxy.io/?'                    // Backup
            ]
        };
        
        let currentApiProxy = 0;
        let currentImageProxy = 0;
        let requestCount = 0;
        let currentData = null;
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        function initApp() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = 'tab-' + this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Search type switching
            document.getElementById('searchType').addEventListener('change', function() {
                const type = this.value;
                document.getElementById('styleInput').style.display = type === 'style' ? 'block' : 'none';
                document.getElementById('packageInput').style.display = type === 'package' ? 'block' : 'none';
                document.getElementById('searchInput').style.display = type === 'search' ? 'block' : 'none';
            });
            
            // Search button
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            
            // Test all images button
            document.getElementById('testAllBtn').addEventListener('click', testAllImages);
            
            // Enter key support
            ['styleCode', 'packageCode', 'searchQuery'].forEach(id => {
                document.getElementById(id).addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') performSearch();
                });
            });
            
            console.log('‚úÖ App initialized with tested proxies');
        }
        
        // ==================== API FUNCTIONS (OPTIMIZED) ====================
        
        async function callMESAPI(endpoint) {
            const targetUrl = CONFIG.MES_BASE_URL + endpoint;
            
            requestCount++;
            document.getElementById('requestCount').textContent = requestCount;
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
            
            // Th·ª≠ c√°c proxy ƒë√£ test th√†nh c√¥ng
            for (let i = 0; i < CONFIG.API_PROXIES.length; i++) {
                const proxyIndex = (currentApiProxy + i) % CONFIG.API_PROXIES.length;
                const proxy = CONFIG.API_PROXIES[proxyIndex];
                
                try {
                    const proxiedUrl = proxy + encodeURIComponent(targetUrl);
                    console.log(`üåê Using proxy ${proxyIndex + 1}: ${proxy}`);
                    
                    const response = await fetch(proxiedUrl, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        signal: AbortSignal.timeout(10000)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Validate response
                        if (data && (data.Result !== undefined || data.IsSuccess !== undefined)) {
                            currentApiProxy = proxyIndex;
                            return { success: true, data };
                        } else {
                            throw new Error('Invalid response structure');
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                } catch (error) {
                    console.log(`‚ùå Proxy ${proxyIndex + 1} failed:`, error.message);
                    continue;
                }
            }
            
            return { 
                success: false, 
                error: 'All proxies failed',
                url: targetUrl
            };
        }
        
        async function testImageExists(imageUrl) {
            // N·∫øu ƒëang ·ªü HTTPS v√† image l√† HTTP, d√πng proxy
            if (window.location.protocol === 'https:' && imageUrl.startsWith('http:')) {
                return await testImageWithProxy(imageUrl);
            }
            
            // Th·ª≠ direct (cho local/HTTP environments)
            return await testImageDirect(imageUrl);
        }
        
        async function testImageWithProxy(imageUrl) {
            // Th·ª≠ c√°c image proxies
            for (let i = 0; i < CONFIG.IMAGE_PROXIES.length; i++) {
                const proxyIndex = (currentImageProxy + i) % CONFIG.IMAGE_PROXIES.length;
                const proxy = CONFIG.IMAGE_PROXIES[proxyIndex];
                
                const proxiedUrl = proxy + encodeURIComponent(
                    imageUrl.replace('http://', '')
                );
                
                const exists = await testImageDirect(proxiedUrl);
                
                if (exists) {
                    currentImageProxy = proxyIndex;
                    return true;
                }
            }
            
            return false;
        }
        
        async function testImageDirect(imageUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = imageUrl + '?t=' + Date.now();
                setTimeout(() => resolve(false), 3000);
            });
        }
        
        // ==================== SEARCH FUNCTIONS ====================
        
        async function performSearch() {
            const searchType = document.getElementById('searchType').value;
            
            showLoading(true);
            clearResults();
            
            try {
                if (searchType === 'style') {
                    await searchByStyleCode();
                } else if (searchType === 'package') {
                    await searchByPackageCode();
                } else if (searchType === 'search') {
                    await searchStyles();
                }
            } catch (error) {
                showError('L·ªói t√¨m ki·∫øm: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function searchByStyleCode() {
            const styleCode = document.getElementById('styleCode').value.trim().toUpperCase();
            
            if (!styleCode) {
                showError('Vui l√≤ng nh·∫≠p Style Code');
                return;
            }
            
            // Get packages and style info in parallel
            const [packagesResult, stylesResult] = await Promise.all([
                callMESAPI(`/packages?stylecode=${styleCode}&pagesize=50`),
                callMESAPI(`/buyerstylecodes?stylecode=${styleCode}`)
            ]);
            
            if (!packagesResult.success && !stylesResult.success) {
                showError(`Kh√¥ng t√¨m th·∫•y style code: ${styleCode}`);
                return;
            }
            
            const packages = packagesResult.success ? packagesResult.data.Result : [];
            const styleInfo = stylesResult.success && stylesResult.data.Result 
                ? stylesResult.data.Result[0] 
                : {};
            
            const buyer = packages[0]?.BUYER || styleInfo.BUYER || styleCode.substring(0, 3);
            
            // Process images
            const images = await processImages(styleCode, buyer, packages, styleInfo);
            
            currentData = {
                styleCode,
                buyer,
                packages,
                styleInfo,
                images,
                packagesMeta: packagesResult.success ? {
                    total: packagesResult.data.TotalRecord,
                    returned: packages.length
                } : null
            };
            
            // Display results
            displayImages(styleCode, buyer, images);
            displayStyleInfo(styleInfo, packages);
            displayPackages(packages);
            displayRawData({ styleCode, buyer, packages, styleInfo, images });
        }
        
        async function searchByPackageCode() {
            const packageCode = document.getElementById('packageCode').value.trim();
            
            if (!packageCode) {
                showError('Vui l√≤ng nh·∫≠p Package Code');
                return;
            }
            
            // Extract style code from package code
            const styleCode = extractStyleCodeFromPackage(packageCode);
            
            if (!styleCode) {
                showError('Package code kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
                return;
            }
            
            document.getElementById('styleCode').value = styleCode;
            await searchByStyleCode();
            
            // Add package info
            if (currentData) {
                currentData.sourcePackage = packageCode;
                displayPackageInfo(packageCode, styleCode);
            }
        }
        
        async function searchStyles() {
            const query = document.getElementById('searchQuery').value.trim();
            
            if (!query || query.length < 2) {
                showError('Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª± ƒë·ªÉ t√¨m ki·∫øm');
                return;
            }
            
            const result = await callMESAPI(
                `/buyerstylecodes?pagesize=20&stylename=${encodeURIComponent(query)}`
            );
            
            if (!result.success) {
                showError(`L·ªói t√¨m ki·∫øm: ${result.error}`);
                return;
            }
            
            displaySearchResults(query, result.data);
        }
        
        async function processImages(styleCode, buyer, packages, styleInfo) {
            const images = [];
            const uniqueFileNames = new Set();
            
            // From packages
            packages.forEach(pkg => {
                if (pkg.FileName && pkg.FileName.trim() && !uniqueFileNames.has(pkg.FileName)) {
                    uniqueFileNames.add(pkg.FileName);
                    images.push({
                        fileName: pkg.FileName,
                        source: 'package',
                        isPrimary: pkg.FileName === styleInfo.PICTURE,
                        packageSource: pkg.MXPACKAGE
                    });
                }
            });
            
            // From style info
            if (styleInfo.PICTURE && styleInfo.PICTURE.trim() && !uniqueFileNames.has(styleInfo.PICTURE)) {
                uniqueFileNames.add(styleInfo.PICTURE);
                images.unshift({
                    fileName: styleInfo.PICTURE,
                    source: 'style',
                    isPrimary: true
                });
            }
            
            // Check image existence
            const checkedImages = [];
            for (const img of images) {
                const imageUrl = `${CONFIG.IMAGE_BASE_URL}/style/${buyer}/${styleCode}/Images/${img.fileName}`;
                const exists = await testImageExists(imageUrl);
                
                if (exists) {
                    checkedImages.push({
                        ...img,
                        url: imageUrl,
                        exists: true
                    });
                }
            }
            
            return checkedImages;
        }
        
        async function testAllImages() {
            const styleCode = document.getElementById('styleCode').value.trim().toUpperCase();
            
            if (!styleCode) {
                showError('Vui l√≤ng nh·∫≠p Style Code');
                return;
            }
            
            const buyer = styleCode.substring(0, 3);
            
            showLoading(true);
            clearResults();
            
            const results = [];
            const imageGrid = document.getElementById('imagesResult');
            
            imageGrid.innerHTML = `
                <h2>üß™ Testing images for: ${styleCode}</h2>
                <div class="image-grid" id="testResultsGrid"></div>
            `;
            
            // Test images 1-9
            for (let i = 1; i <= 9; i++) {
                const fileName = `${styleCode}${i}.jpg`;
                const imageUrl = `${CONFIG.IMAGE_BASE_URL}/style/${buyer}/${styleCode}/Images/${fileName}`;
                
                const exists = await testImageExists(imageUrl);
                
                results.push({
                    fileName,
                    url: imageUrl,
                    exists,
                    sequence: i
                });
                
                // Update UI progressively
                updateTestResults(results);
            }
            
            const foundCount = results.filter(r => r.exists).length;
            
            imageGrid.innerHTML += `
                <div class="success-box" style="margin-top: 20px;">
                    <h3>‚úÖ Test Complete</h3>
                    <p>Found ${foundCount} out of ${results.length} images</p>
                </div>
            `;
            
            showLoading(false);
        }
        
        // ==================== DISPLAY FUNCTIONS ====================
        
        function displayImages(styleCode, buyer, images) {
            const container = document.getElementById('imagesResult');
            
            if (images.length === 0) {
                container.innerHTML = `
                    <div class="error-box">
                        <h3>‚ùå Kh√¥ng t√¨m th·∫•y ·∫£nh</h3>
                        <p>Style: <strong>${styleCode}</strong> | Buyer: <strong>${buyer}</strong></p>
                        <button onclick="testAllImages()" class="btn" style="margin-top: 10px;">
                            üß™ Test T·∫•t C·∫£ ·∫¢nh
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <h2>üñºÔ∏è Images for: ${styleCode}</h2>
                <p><strong>Buyer:</strong> ${buyer} | <strong>Found:</strong> ${images.length} images</p>
                <div class="image-grid">
            `;
            
            images.forEach(img => {
                html += `
                    <div class="image-card">
                        <img src="${img.url}" alt="${img.fileName}"
                             onerror="this.src='https://via.placeholder.com/280x220/eee/999?text=Image+Not+Loaded'">
                        <div class="image-info">
                            <div class="image-title">${img.fileName}</div>
                            <div class="image-meta">
                                ${img.isPrimary ? '<span class="status-badge status-found">Primary</span>' : ''}
                                <span class="status-badge ${img.exists ? 'status-found' : 'status-not-found'}">
                                    ${img.exists ? '‚úÖ Found' : '‚ùå Missing'}
                                </span>
                            </div>
                            <div style="margin-top: 10px;">
                                <a href="${img.url}" target="_blank" style="color: #667eea; text-decoration: none;">
                                    üîó Open Original
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }
        
        function displayStyleInfo(styleInfo, packages) {
            const container = document.getElementById('infoResult');
            
            let html = `<h2>üìã Style Information</h2>`;
            
            if (!styleInfo || Object.keys(styleInfo).length === 0) {
                html += `<p class="error-box">Kh√¥ng c√≥ th√¥ng tin style</p>`;
            } else {
                html += `<div class="info-grid">`;
                
                // Display key fields
                const keyFields = [
                    'STYLECODE', 'BUYER', 'STYLENAME', 'BUYERSTYLECODE', 
                    'BUYERSTYLENAME', 'STATUS', 'FACTORY', 'REGISTRYDATE'
                ];
                
                keyFields.forEach(field => {
                    if (styleInfo[field]) {
                        html += `
                            <div class="info-card">
                                <h4>${field}</h4>
                                <p>${styleInfo[field]}</p>
                            </div>
                        `;
                    }
                });
                
                html += `</div>`;
            }
            
            container.innerHTML = html;
        }
        
        function displayPackages(packages) {
            const container = document.getElementById('packagesResult');
            
            if (!packages || packages.length === 0) {
                container.innerHTML = `<p class="error-box">Kh√¥ng c√≥ packages</p>`;
                return;
            }
            
            let html = `
                <h2>üì¶ Packages (${packages.length})</h2>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Package</th>
                                <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Line</th>
                                <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Status</th>
                                <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Filename</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            packages.slice(0, 20).forEach(pkg => {
                html += `
                    <tr style="border-bottom: 1px solid #e9ecef;">
                        <td style="padding: 12px;">${pkg.MXPACKAGE || 'N/A'}</td>
                        <td style="padding: 12px;">${pkg.LINENAME || 'N/A'}</td>
                        <td style="padding: 12px;">
                            <span class="status-badge ${pkg.MXSTATUS === 'CF' ? 'status-found' : 'status-not-found'}">
                                ${pkg.MXSTATUS || 'N/A'}
                            </span>
                        </td>
                        <td style="padding: 12px;">${pkg.FileName || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            if (packages.length > 20) {
                html += `<p style="margin-top: 15px; color: #6c757d;">... v√† ${packages.length - 20} packages kh√°c</p>`;
            }
            
            container.innerHTML = html;
        }
        
        function displayRawData(data) {
            const container = document.getElementById('rawResult');
            container.innerHTML = `
                <h2>üìÑ Raw API Response</h2>
                <div class="api-response">
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }
        
        function displaySearchResults(query, data) {
            const container = document.getElementById('imagesResult');
            
            if (!data.Result || data.Result.length === 0) {
                container.innerHTML = `<div class="error-box">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ cho: "${query}"</div>`;
                return;
            }
            
            let html = `
                <h2>üîç Search Results: "${query}"</h2>
                <p>Found ${data.TotalRecord || data.Result.length} results</p>
                <div class="info-grid">
            `;
            
            data.Result.forEach(item => {
                html += `
                    <div class="info-card">
                        <h4>${item.STYLECODE} - ${item.STYLENAME}</h4>
                        <div class="info-item">
                            <span class="info-label">Buyer:</span>
                            <span class="info-value">${item.BUYER || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status:</span>
                            <span class="info-value">
                                <span class="status-badge ${item.STATUS === 'OK' ? 'status-found' : 'status-not-found'}">
                                    ${item.STATUS || 'N/A'}
                                </span>
                            </span>
                        </div>
                        <button onclick="loadStyle('${item.STYLECODE}')" 
                                class="btn" style="margin-top: 10px; padding: 8px 12px;">
                            üîç View Details
                        </button>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }
        
        function displayPackageInfo(packageCode, styleCode) {
            const container = document.getElementById('infoResult');
            const existing = container.innerHTML;
            
            container.innerHTML = `
                <div class="success-box">
                    <h3>üì¶ Package Code Analyzed</h3>
                    <div class="info-item">
                        <span class="info-label">Package:</span>
                        <span class="info-value">${packageCode}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Extracted Style:</span>
                        <span class="info-value">${styleCode}</span>
                    </div>
                </div>
                ${existing}
            `;
        }
        
        function updateTestResults(results) {
            const grid = document.getElementById('testResultsGrid');
            if (!grid) return;
            
            grid.innerHTML = results.map(img => `
                <div class="image-card">
                    <img src="${img.url}" alt="${img.fileName}"
                         onerror="this.src='https://via.placeholder.com/280x220/eee/999?text=Testing...'">
                    <div class="image-info">
                        <div class="image-title">${img.fileName}</div>
                        <div class="image-meta">
                            <span class="status-badge ${img.exists ? 'status-found' : 'status-not-found'}">
                                ${img.exists ? '‚úÖ Found' : '‚ùå Not found'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ==================== HELPER FUNCTIONS ====================
        
        function extractStyleCodeFromPackage(packageCode) {
            const parts = packageCode.split('_');
            if (parts.length < 4) return null;
            
            const stylePart = parts[3];
            if (stylePart.length >= 7) {
                return stylePart.substring(0, 7).toUpperCase();
            }
            
            return null;
        }
        
        function loadStyle(styleCode) {
            document.getElementById('styleCode').value = styleCode;
            document.getElementById('searchType').value = 'style';
            document.getElementById('searchType').dispatchEvent(new Event('change'));
            performSearch();
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            const container = document.getElementById('imagesResult');
            container.innerHTML = `
                <div class="error-box">
                    <h3>‚ùå Error</h3>
                    <p>${message}</p>
                    <p style="margin-top: 10px; font-size: 0.9rem;">
                        Using tested CORS proxies: ${CONFIG.API_PROXIES[currentApiProxy]}
                    </p>
                </div>
            `;
        }
        
        function clearResults() {
            ['imagesResult', 'infoResult', 'packagesResult', 'rawResult'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }
        
        // Initial message
        window.onload = function() {
            document.getElementById('imagesResult').innerHTML = `
                <div class="success-box">
                    <h3>‚úÖ System Ready</h3>
                    <p>MES Image Finder is ready with tested CORS proxies.</p>
                    <p><strong>Tested Proxies:</strong></p>
                    <ul>
                        <li>üåê API: ${CONFIG.API_PROXIES[0]} (8ms - tested)</li>
                        <li>üåê Backup: ${CONFIG.API_PROXIES[1]} (1.3s - tested)</li>
                        <li>üñºÔ∏è Images: ${CONFIG.IMAGE_PROXIES[0]}</li>
                    </ul>
                    <p>Enter a style code and click Search to begin.</p>
                </div>
            `;
        };
    </script>
</body>
</html>
